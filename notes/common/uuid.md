---
title: "UUID"
tags:
draft: false
---

**UUID** - universal unique identifier - глобальный уникальный идентификатор.

UUID используется в качестве идентификатора какого-либо объекта в распределенных системах.

Так можно делать, благодаря тому что шанс коллизии очень мал.

Для хранения UUID требуется 128 бит, что обеспечивает невероятное количество вариантов.

В Windows системах используется понятие GUID - это то же самое, что и UUID.

## Формат

Записывают UUID обычно в виде 32 символов 16-ричной системы счисления, разбитых на блоки по 8-4-4-4-12 символов.

```
67a83e20-fc8a-11ea-adc1-0242ac120002
xxxxxxxx-xxxx-Mxxx-Nxxx-xxxxxxxxxxxx
```

4 бита M обозначают версию UUID, а от 1 до 3 старших битов N обозначают вариант UUID.

| **Название поля** | **Длина в битах** | **Значение** |
| --- | --- | --- |
| `time_low` | 32  | Младшие 32 бита времени |
| `time_mid` | 16  | Средние 16 бит времени |
| `time_hi_and_version` | 16  | 4 бита на версию и старшие 12 бит времени |
| `clock_seq_hi_and_res` | 16  | 1-3 бита на вариант UUID и 13-15 бит на clock sequence |
| `node` | 48  | идентификатор узла |

Такие названия соответствуют только 1 версии UUID, однако они прижились и для остальных версий.

### Версии

- 0 - null версия UUID. Все остальные биты тоже должны быть 0.
- 1 - UUID сгенерирован на основе времени и MAC-адреса устройства
- 2 - что-то непонятное на основе DCE. Часть битов времени отдана под нужды DCE, из-за этого можно сгенерировать всего 64 UUID в 7 минут. Версия почти не используется
- 3 - UUID сгенерирован на основе имени генерируемого объекта. При генерации используется алгоритм хэширования MD-5.
- 4 - UUID сгенерирован рандомно. В Java для этого используется статический метод генерации.
- 5 - то же самое, что и 3, но использует алгоритм хэширования SHA-1. в Java не поддерживается

В версии 1 на метку времени отводится в сумме 60 бит.
Время отсчитывается от некой фиксированной даты (не UNIX time) и может отсчитываться в обе стороны от нее.
Единица времени - 100 нс.

Для того чтобы защититься от откручивания системного времени назад в версии 1 есть часть clock sequence.
При рестарте сервиса это значение должно изменяться относительно предыдущего значения.
Предыдущее значение должно храниться в специальном файлике на диске.
Если такого файлика нет, то значение выбирается рандомно.

В связи с тем, что фрагменты времени упорядочены в обратном порядке - `low -> mid -> high` вместо `high -> mid -> low`, UUID'ы первой версии невозможно правильно отсортировать лексиграфически.
Из-за всех этих странностей лучше не использовать UUID версии 1.
Вместо него можно использовать [другие реализации](../architecture/unique_id.md), основанные на метке времени.

### Варианты

- 0 - используется для совместимости с устаревшим форматом UUID.
- 1 - стандартный вариант.
- 2 - стандартный вариант, отличается от 1 тем, что по-другому кодируется при передаче.
- 3 - зарезервирован на будущее.

В Java используется вариант 2.


## UUID в Java
В Java существует специальный класс для представления UUID'ов, который так и называется - `UUID`.
В своей стандартной реализации он позволяет представлять UUID версий от 1 до 4.
Но генерировать можно только UUID версий 3 и 4.
```java
UUID randomUuid = UUID.randomUUID();
assertEquals(2, randomUuid.variant());
assertEquals(4, randomUuid.version());

UUID namedUuid = UUID.nameUUIDFromBytes("name".getBytes());
assertEquals(2, namedUuid.variant());
assertEquals(3, namedUuid.version());
```

Если хочется сгенерировать UUID версии 1, то необходимо прибегать к сторонним библиотекам.
Самой популярной является Java UUID Generator.
```java
UUID uuid = Generators.timeBasedGenerator().generate();
```

---
## К изучению

- [X] [Вики](https://ru.wikipedia.org/wiki/UUID)
- [X] Стандарт [RFC-4122](https://www.rfc-editor.org/rfc/rfc4122.html)
- [X] Javadoc на класс UUID
- [X] Библиотека [Java UUID Generator](https://github.com/cowtowncoder/java-uuid-generator)