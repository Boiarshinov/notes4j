---
title: "Kafka Client"
tags:
  - kafka
draft: false
---

# Kafka Client

Kafka Client - это Java библиотека, предназначенная для работы с [Apache Kafka](../tools/kafka.md).
Подключается библиотека, как и всякая другая:
```xml
<dependency>
    <groupId>org.apache.kafka</groupId>
    <artifactId>kafka-clients</artifactId>
    <version>2.7.1</version>
</dependency>
```

Кафка воспринимает все записи как байтовые массивы.
Но на уровне Java-кода для обеспечения типобезопасности можно работать с обычными Java-объектами, а сериализовать их в массив байт только непосредственно перед записью в Кафку.
Для этого все основные объекты Kafka Client сделаны обобщенными по двум типам - типу ключа и значения.
```java
ProducerRecord<String, String> producerRecord = null;
KafkaProducer<String, String> kafkaProducer = null;
KafkaConsumer<String, String> kafkaConsumer = null;
ConsumerRecord<String, String> consumerRecord = null;
```

Алгоритм преобразования POJO в байтовый массив задается с помощью реализации интерфейса `Serializer`.
В обратную сторону - с помощью `Deserializer`.
Существует несколько стандартных реализаций этих интерфейсов для некоторых Java-классов из стандартной библиотеки: `StringSerializer`, `UUIDDeserializer` и т.д.
Для собственных типов можно написать свои сериализаторы / десериализаторы.


## Запись данных

Запись данных в Kafka производится с помощью объекта класса `KafkaProducer`.
Запись передается в виде объекта `ProducerRecord`.

```java
var record = new ProducerRecord<>("topic_name", "custom_key", "custom_value");
```

Продюсер не отправляет сообщение сразу же. 
У него есть буфер, в который помещаются сообщения на запись. 
Когда буфер заполнится, сообщения будут отправлены батчом.
Если буфер не заполняется долгое время, то сообщения будут отправлены по таймауту.


### Настройка продюсера

Настройка продюсера происходит при создании экземпляра данного класса.
В конструктор передается объект типа `Properties` или мапа строк.
Основные настройки:
- `bootstrap.servers` - список хостов, с помощью которых можно подключиться к кластеру брокеров. Необязательно указывать все ноды, но желательно больше одной
- `key.serializer` - имя класса, использующегося для сериализации ключей
- `value.serializer` - имя класса, использующегося для сериализации значений

```java
Properties properties = new Properties();
// Названия настроек можно импортировать из класса ProducerConfig, чтобы точно не ошибиться с наименованиями
properties.put("bootstrap.servers", kafkaProperties.getServers());
properties.put("key.serializer", StringSerializer.class.getCanonicalName());
properties.put("value.serializer", StringSerializer.class.getCanonicalName());

KafkaProducer<String, String> kafkaProducer = new KafkaProducer<>(properties);
```

При отправке сообщения могут возникать какие-либо ошибки.
Ошибки могут быть как подлежащие исправлению, так и нет.
Например, при потере соединения с кластером оно еще может восстановиться и сообщение можно будет переотправить, а вот если был выбран неправильный сериализатор - то сколько раз не пробуй перепослать запись, все будет бестолку.
Параметры переотправки можно настроить.
По умолчанию интервал между переотправками - 100 мс, а количество попыток - бесконечное

Настроек великое множество.
Подробно прочитать про них можно в классе `ProducerConfig`.
Вот некоторые из них:
- `acks` - сколько реплик партиции должно ответить, чтобы считать запись в Кафку успешной. `0` - всегда считаем запись успешной. `1` - успешно, если ответила лидер-реплика. `all` - успешно, если ответили все реплики. По умолчанию `1`
- `buffer.memory` - объем буфера, который используется для временного хранения сообщений перед отправкой в Кафку. Сообщения попадают туда, когда продюсер не успевает отправлять поток сообщений
- `compression.type` - способ сжатия данных перед отправкой в Кафку. Возможные значения: `none`, `gzip`, `snappy`, `lz4`, `zstd`. По умолчанию `none`
- `retries` - количество переповторов, которые попробует сделать продюсер, прежде чем выкинуть исключение.
- `batch.size` - объем батча в байтах, при заполнении которого сообщения отправляются из буфера в Кафку.
- 