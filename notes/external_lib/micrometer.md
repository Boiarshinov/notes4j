---
title: "Micrometer"
tags:
  - external_lib
  - monitoring
draft: false
---

# Micrometer

Micrometer - это вендор-независимая библиотека, абстрагирующая сбор метрик.
Сам Micrometer предоставляет интерфейсы и базовые классы для описания различных метрик.
Доставку метрик до конкретной системы хранения и визуализации метрик берут на себя различные адаптеры.
В терминах Micrometer системы хранения называются `Registry`.

Каждая метрика характеризуется с помощью:
- название
- множество тегов
- текущее значение метрики

При этом уникальным ключом, однозначно идентифицирующим метрику, является совокупность названия и тегов.

Название метрики по возможности должно выражаться одним словом. 
Если одного слова недостаточно, то нужно разделять слова с помощью точки `<part>.<part>`.
Адаптеры затем преобразуют название метрики так, чтобы оно удовлетворяло правилам, установленным конкретным registry.

Тэг - это пара ключ-значение, уточняющая метрику по какому-либо признаку.
Каждый тег - это дополнительное измерение (в смысле dimension) метрики.

Между различными системами сборки метрик есть существенные отличия, которые необходимо принимать во внимание.
Из таких различий:
- Публикация:
  - сервис самостоятельно пушит метрики в систему мониторинга
  - система мониторинга извлекает метрики из сервиса через какой-либо API
- Агрегация данных:
  - система мониторинга получает сырые данные и сама может их агрегировать
  - система мониторинга ожидает уже агрегированные данные
- Размерность
  - метрики выстраиваются в строгую иерархию
  - метрики могут быть собраны по нескольким измерениям, которые выражаются с помощью тэгов.


## API

Различные системы хранения описываются с помощью интерфейса `MeterRegistry`.
Этот интерфейс реализуют различные адаптеры.
В стандартную библиотеку входят реализации:
- `CompositeMeterRegistry` - агрегирующий registry, позволяющий одновременно отправлять метрики в несколько систем хранения. Является декоратором для конкретных registry.

Все метрики реализуют интерфейс `Meter`.
Виды метрик:
- `Counter` - счетчик каких-либо событий. Может только расти, но необязательно монотонно. Подходит, например, для подсчета количества обращений к чему-либо
- `Gauge` - текущее значение какого-либо параметра. Подходит, например, для измерения использования памяти приложением или определения значений с какого-либо датчика
- `Timer` - засекает время, потраченное на выполнение какой-либо операции.
- `LongTaskTimer` - засекает время выполнения длинных тасок (дольше минуты) и подсчитывает количество таких тасок.
- `DistributionSummary` - измеряет распределение каких-либо значение по событиям.
- другие

Создавать метрики можно различными способами:
- с помощью фабричного класса `Metrics`. В этом же классе можно зарегистрировать registry, которые станут глобальными для всего сервиса
- с помощью объекта `MeterRegistry`. В этом случае метрики будут отдаваться только в этот registry
- с помощью билдера, объявленного в каждой из метрик. Во всех стандартных метриках билдер есть, в каких-либо специфических может не быть

Рекомендуется записывать метрики в поля классов.
В некоторых случаях необходимо вытаскивать значение тэгов из контекста, тогда придется строить метрики на лету (чаще всего нужные метрики будут доставаться из кэша, но это тоже не бесплатно).

### Тэги
Тэг описывается парой ключ-значение.
Где ключ - это измерение метрики, а значение - конкретный отступ по оси этого измерения.
При объявлении метрики описываются ее теги.

Существует возможность объявить глобальные теги, которые будут присвоены каждой метрике в приложении.
Это может быть полезно, чтобы например, разграничить метрики по стендам разработки:
```java
registry.config().commonTags(Tags.of("stand", appProps.getStand()));
```
Делать это нужно на старте приложения.

### Тестирование
В core библиотеке есть класс `SimpleMeterRegistry`, который никуда не пушит метрики.
Он хранит последнее значение метрики в памяти.
Его можно использовать в качестве стаба в тестах на сервисы, в которых используются метрики.


## Подключение

Все абстракции Micrometer находятся в библиотеке `micrometer-core`.
Если в проекте используется какая-нибудь стандартная система сборка метрик, то можно сразу подключить ее адаптер, а он транзитивно подтянет основную либу.
Например для [Prometheus](../tools/prometheus.md) адаптер называется `micrometer-registry-prometheus`.

### Интеграция со Spring
Micrometer был разработан компанией Pivotal и потому имеет тесную интеграцию со Spring.

todo


---
## К изучению

- [ ] [Официальная документация](https://micrometer.io/docs/concepts)