---
title: "Сессии"
tags:
  - servlet
  - java_ee
  - web
draft: false
---

**Сессия** - сохранение данных о действии пользователя на сайте.

Сведения о сессии хранятся на сервере и работают с помощью *cookies*, которые хранятся в браузере на стороне клиента.

Контейнер сервлетов при первом запросе от пользователя автоматически присваивает ему уникальный идентификатор, и отправляет его пользователю. При последующих запросах браузер пользователя высылает свой идентификатор серверу, чтобы поддерживать сессию. Этот уникальный идентификатор представляется в виде [Cookies](cookies.md).

Если клиент не признает куки и отключил их в браузере, то в качестве выхода можно хранить уникальный идентификатор во всех URL. Это будет сделано автоматически контейнером сервлетов, если мы будем энкодировать все URL с помощью метода `response.encodeURL()`.

Примеры необходимости введения сессий:
- подсчет посещений страницы конкретным пользователем
- сохранение данных о корзине в случае интернет-магазина

---
## Возможные причины завершения сессии
- Время неактивности пользователя превысило максимально допустимое
- На сессии был вызван метод invalidate()
- Упал сервер (или был перезапущен)

---
## Продолжительность сессии
Стандартная продолжительность жизни сессии в java EE - 30 минут.

Настроить стандартную продолжительность жизни сессии можно в [дескрипторе развертывания](deployment_descriptor.md) с помощью тега `<session-timeout>`.

Также выставить продолжительность жизни сессии можно в runtime с помощью метода `setMaxInactiveInterval()` класса `HttpSession`.

---
## Атрибуты сессии

У каждой сессии есть перечень атрибутов. Атрибуты и действия над ними устанавливаются в сервлете.

[Атрибут](webapp_attributes.md) - это именованный POJO, который доступен всем участникам сессии.

---
## Миграция сессий

При разнесенном веб-приложении сессиям необходимо мигрировать между нодами, потому что сессия может быть только одна на клиента для всего веб-приложения.

Если нода обнаруживает, что у нее нет сессии с идентификатором, который пришел в запросе клиента, она понимает, что сессия находится на другой ноде, и организует миграцию сессии с той ноды к себе.

---
## HttpSession

В условиях веб-приложения, разнесенного по нескольким серверам (нодам) объект сессии для определенного пользователя всегда существует только на одной ноде и при необходимости перемещается между ними.

Конструкторы:
- Объекты класса получают в сервлетах путем вызова из request метода `getSession()`
```java
HttpSession session = request.getSession();
```

Методы:
- Посвященные атрибутам:
    - `Object getAttribute(String name)` - возвращает атрибут с указанным именем
    - `void setAttribute(String name, Object)` - устанавливается атрибут сессии и его начальное значение
    - `void removeAttribute(String name)` - удаляет из сессии атрибут с указанным именем
    - `Enumeration getAttributeNames()` - возвращает перечисление имен атрибутов, что позволяет их проитерировать.
```java
protected void doGet(HttpServletRequest request, HttpServletResponse response) throws IOException{

    HttpSession session = request.getSession();
    Integer count = (Integer) session.getAttribute("count");
    if (count == null) count = 0;
    session.setAttribute("count", count++);
}
```

- `boolean isNew()` - возвращает true, если сессия новая
- `getCreationTime()` - возвращает время создания сессии
- `getLastAccessedTime()` - возвращает время последнего обращения от данной сессии
- `setMaxInactiveInterval(int)` - устанавливает *в секундах* максимальный интервал отсутствия, при котором сессия будет завершена
- `getMaxInactiveInterval()` - возвращает вышеуказанный параметр
- `void invalidate()` - уничтожает сессию