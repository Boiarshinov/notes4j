---
title: "Batch operations"
tags:
  - api
  - rest
draft: false
---

# Пакетные операции

Для чего нужны пакетные операции:
- атомарность выполнения действия над несколькими ресурсами
- уменьшение количества вызовов

Пакетные операции:
- BatchGet
- BatchCreate
- BatchUpdate
- BatchDelete

Для простоты лучше все пакетные операции делать атомарными.
Если не получилось выполнить какое-либо действие над одним ресурсом, то возвращать ошибку на весь запрос.
Иначе API с поддержкой частичного исполнения батчовых операций станет слишком замудреным.

Для описания пакетных операций отлично подходят [пользовательские методы](./custom_methods.md).
Для всех батчовых операций стоит использовать http-метод POST с указанием пакетной операции в конце пути URI:
```
POST /resources/batchCreate
POST /resources/batchGet
POST /resources/batchDelete
POST /resources/batchUpdate
```


## Упорядочивание элементов пакета
При запросе данных, обновлении и удалении в батчовую операцию передаются идентификаторы ресурсов, над которыми исполняется действие.
И сопоставить элементы в ответе с изначальным запросом можно по идентификаторам.
В этом случае порядок элементов в ответе не важен.

Но при батчовом создании ресурсов в исходном запросе нет идентификаторов (если [идентификаторы](./identifiers.md) назначаются сервисом).
Поэтому в ответе на BatchCreate обязательно нужно возвращать ресурсы в том же порядке, в каком они были переданы.


## BatchGet

Для единообразия с остальными пакетными операциями лучше сделать пакетный Get на http POST:
```
POST /resources/batchGet
{
    ids: [
        "id1",
        "id2"
    ]
}
```
Такой подход также позволит докинуть в запрос какие-либо данные при необходимости.
Например, [маску по полям](./partial_operations.md).

Иногда можно сделать пакетный Get на http GET, но нужно учитывать ограничения на длину URI:
```
GET /resources/batchGet?ids=id1,id2,id3
```

> Стоит ли давать возможность запроса дочерних ресурсов из разных родительских ресурсов

Реализовать такое может быть не слишком сложно на начальном этапе.
Но с развитием системы родительские ресурсы могут быть раскиданы по разным шардам БД и тогда такой запрос станет довольно тяжелым.
Поэтому нужно в каждом случае задумываться о решении, и оценивать потенциал развития сервиса и API.


> Что делать, если в одном из ста переданных идентификаторов есть форматная ошибка?

С одной стороны для всех пакетных операций желательно возвращать общую ошибку при ошибке в любом из элементов, чтобы обеспечить атомарность выполнения запроса.
С другой стороны, Get в любом случае атомарен, так как он не меняет запрашиваемые данные.


> У нас могут запросить множество ресурсов, нужно ли делать пагинацию?

Не нужно.
Для пагинации есть отдельный метод List с фильтрами.
Если очень хочется, то можно ограничить количество ресурсов, по которым идет запрос.


## BatchCreate
```
POST /resources/batchCreate
{
    "createRequests": [
        { "key": "value" },
        { "key": "value" }
    ]
}
```

В каких-то случаях необходимо создать пачку дочерних ресурсов для нескольких родителей. 
При этом желательно добавлять ссылку на родительский ресурс в элемент массива с запросом на создание:
```
POST /parent/-/resources/batchCreate
{
    "createRequests": [
        { 
            "parentId": "id1",
            "resource": { "key": "value" }
        },
        { 
            "parentId": "id2",
            "resource": { "key": "value" }
        }
    ]
}
```
А в пути можно вместо идентификатора конкретного родителя использовать какой-нибудь wildcard символ, например дефис __'-'__.

> При создании батча могут быть допущеные форматные или бизнесовые ошибки в полях разных элементов. Как при этом правильно репортить об ошибках?


> В каком виде возвращать ошибки?

---
## К изучению
- [X] Книга "Паттерны проектирования API". Глава 18
- [ ] Google [AIP-231 Batch Get](https://google.aip.dev/231)
- [ ] Google [AIP-233 Batch Create](https://google.aip.dev/233)
- [ ] Google [AIP-234 Batch Update](https://google.aip.dev/234)
- [ ] Google [AIP-235 Batch Delete](https://google.aip.dev/235)
