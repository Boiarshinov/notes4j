---
title: "Singleton resource"
tags:
  - api
  - rest
draft: false
---

# Ресурс-одиночка

Очень часто требуется выделить часть ресурса в отдельный подресурс.
Причины могут быть следующие:
- часть ресурса имеет очень большой размер
- у ресурса и его части должны быть разные уровни доступа. 
- имеет смысл выделить метаданные о ресурсе или его конфигурацию
- какие-то данные ресурса меняются чаще, чем другие данные. Например, координаты такси меняются чаще, чем контакты водителя

Выделяя подресурс, необходимо осознавать, что атомарное обновление ресурса и его подресурса будет невозможно.
Поэтому выделять нужно только те свойства, которые хорошо отчуждаются от основного ресурса.

У подресурса нет своего собственного идентификатора.
Путь до подресурса-одиночки будет выглядеть так: `/resources/{id}/singleton`.

В общем случае для подресурса-одиночки нужны всего два метода:
- Get
- Update

```
GET /resources/{id}/singleton

PATCH /resources/{id}/singleton
{
    "property": "value"
}
```


### Создание
Отдельный метод создания подресурса-одиночки не нужен, так как подресурс должен создаваться совместно со своим родительским ресурсом.
Но при этом возникает проблема, что в API создания родительского ресурса нет (не должно быть) полей подресурса, так как мы их оттуда выделили в отдельный подресурс.

Решений тут может быть несколько:
1) При создании ресурса не создавать подресурс вовсе. Но такой выход годится только для случаев, когда подресурс может быть nullable.
2) При создании ресурса заполнять поля подресурса дефолтными значениями, либо рассчитывать их на основе полей родительского ресурса. Но не всегда дефолтные значения будут удовлетворять инвариантам ресурса. Дефолтные значения могут быть сразу переопределены отдельным вызовом метода API Update подресурса: то есть для создания ресурса необходимо будет вызвать два метода - Create основного ресурса и Update подресурса. Но между этим вызовами ресурс будет находится в неконсистентном состоянии.
3) Все-таки добавить в метод создания родительского ресурса поля подресурса-одиночки.

### Удаление
Отдельного метода удаления подресурса-одиночки так же не требуется в большинстве случаев.
Подресурс должен удаляться совместно со своим родителем.

Но если подресурс является nullable, то отдельная операция удаления вполне допустима.
```
DELETE /resources/{id}/singleton
```

### Сброс
Некоторые подресурсы, могут требовать сброса к дефолтным значениям.
Например, если в подресурс вынесена конфигурация ресурса.
Тогда целесообразно выделить [пользовательский метод](./custom_methods.md) сброса.
```
POST /resources/{id}/singleton/reset
```

---
## К изучению
- [X] Книга "Паттерны проектирования API". Глава 12
- [X] Google [AIP-156](https://google.aip.dev/156)