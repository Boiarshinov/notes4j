---
title: "Partial Updates"
tags:
  - api
  - rest
draft: false
---

# Частичное обновление и извлечение

## Частичное извлечение

Частичное извлечение не стоит превращать в graphQL. 
Его нужно использовать только в тех случаях, когда какие-то части ресурса слишком большие, и их затратно передавать при каждом вызове ресурса.

В разных языках и в разных фреймворках принято по-разному обрабатывать параметры URI.
Spring Boot Web поддерживает и так, и сяк:
```
GET /resource/{id}?fieldMask=field1,field2

GET /resource/{id}?fieldMask=field1&fieldMask=field2
```

Для обращения к вложенным полям можно использовать нотацию через точку: `object.subObject.field`.
Чтобы запросить все поля объекта можно использовать wildcard `*`: `object.subObject.*`.
Также wildcard может использоваться при запросе полей объектов, лежащих в массиве: `objectArray.*.field`.

Существуют ли готовые библиотеки для обработки подобного синтаксиса? 
Я пока не искал.
Но точно не стоит использовать синтаксис JsonPath, потому что он слишком гибкий для данной задачи.

Некоторые поля могут не возвращаться при запросе GET без маски, но при этом возвращаться если указаны в маске.
Как правило, это поля большого объема, и, чтобы не грузить сеть, пользователь API должен явно выразить желание получить эти поля.

```
GET /resource/{id}
GET /resource/{id}/full
```


## Частичное обновление

При использовании полного изменения могут пострадать данных при конкурентом обновлении данных несколькими клиентами.
От момента получения данных с сервера до отправки запроса на изменение, данные на серверы уже могли быть обновлены другим клиентом.
Это может приводить к тому, что изменения одного клиента перезатирают изменения другого клиента.
С точки зрения API без использования дополнительных ухищрений невозможно понять какие данные из запроса на обновление хотели поменять, а какие оставить прежними.

С развитием API при добавлении новых полей в ресурс любое полное обновление становится частичным.

```
PATCH /resource/{id}
{
  "changedField": "value"
}
```


Если хотим удалить ключ из мапы, как это сделать?
```
PATCH /resource/{id}?fieldMask=map.key
{ }
```

---
## К изучению
- [X] Книга "Паттерны проектирования API". Глава 8
- [ ] RFC-6902 [JSON Patch](https://datatracker.ietf.org/doc/html/rfc6902)
- [ ] RFC-7396 [JSON Merge Patch](https://datatracker.ietf.org/doc/html/rfc7396)
- [ ] Библиотека [json-patch](https://github.com/java-json-tools/json-patch) для Java
- [ ] [Гайд](https://www.baeldung.com/spring-rest-json-patch) по использованию json-patch в Spring Boot приложениях
- [X] [Неработающий гайд](https://ololx.medium.com/partial-data-update-in-java-rest-services-1-332fdc621631) по partial update с помощью jackson `objectMapper.updateValue()`
- [ ] [Микробиблиотека для частичного обновления](https://habr.com/ru/articles/542818/) с хабра
