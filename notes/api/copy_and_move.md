---
title: "Copy and Move methods"
tags:
  - api
  - rest
draft: false
---

# Методы Copy и Move

Клиенты нашего API иногда могут совершать ошибки при создании ресурсов.
Надо предоставить клиентам возможность исправить эти ошибки, а также возможность поэкспериментировать с ресурсами.
Для этого нужны методы Copy и Move - копирование и перемещение.

Стоит десять раз подумать прежде чем добавлять эти два метода в свой API. 
Т.к. они порождают большое количество тонких моментов.
Возможно вместо копирования лучше дать пользователю создать новый ресурс, заполнив его оригинального ресурса.
А вместо перемещения предложить клиенту вызывать две операции: создание и удаление.

Перемещение решает две проблемы: перенос ресурса в другого родителя и переименование ресурса.


---
## Идентификаторы
При копировании новый ресурс должен получить новый [идентификатор](./identifiers.md) либо от системы, либо от пользователя, копирующего ресурс.
При перемещении ресурса в каких-то случаях он может сохранять свой прежний идентификатор.
Рассмотрим это подробнее.

### Копирование
Если у типа копируемого ресурса были допустимы пользовательские идентификаторы, то при копировании необходимо дать возможность пользователю назначить новый идентификатор.
В некоторых случаях поле с новым идентификатором нужно делать необязательным, чтобы если клиент не хочет думать над новым идентификатором, генерировать его на стороне сервера.
```
POST /exam/{examId}/copy
{
    "destinationId": "new_exam_id"
}
```
Если предлагаемый идентификатор уже занят, то нужно возвращать ошибку.

Если же для типа копируемого ресурса идентификаторы назначались самой системой, то и при копировании новый идентификатор должен назначаться системой, а у пользователя не должно быть возможности назначить новый идентификатор самостоятельно.
```
POST /exam/{examId}/copy
```

### Перемещение
Перемещение ресурса может быть нужно по двум причинам: перенос в другой родительский ресурс и переименование ресурса.
Вторая причина в очередной раз доказывает, что лучше не давать возможность пользователю самостоятельно определять идентификатор ресурса, а вместо этого генерировать id на стороне сервера.

При перемещении ресурса из одной иерархии в другую, желательно сохранять его идентификатор:
```
/exam/exam_1/task/task_1 -> /exam/exam_5/task/task_1
```

```
POST /exam/{examId}/task/{taskId}/move
{
    "destinationParentId": "exam_id_2"
}
```

Если для ресурса разрешены пользовательские идентификаторы, то нужно дать возможность при перемещении переименовать ресурс.
Такой метод может быть даже у тех ресурсов, которые находятся на вершине иерархии (не имеют родителей, между которыми их нужно было бы перемещать).
```
POST /exam/{examId}
{
    "destinationId": "exam_id_new"
}
```


---
## Дочерние ресурсы
При копировании и перемещении родительского ресурса в большинстве случаев необходимо также копировать и перемещать все дочерние ресурсы.
Иначе будет как-то странно.
При проектировании такого API нужно будет внимательно посмотреть на все ресурсы, которые есть в API и проверить, не являются ли они дочерними к тому ресурсу, который мы хотим скопировать.
При развитии API могут возникать такие ситуации, когда ресурс является дочерним по отношению к другому ресурсу, но эта связь по историческим причинам или по неопытности не была отражена в пути до ресурса.


---
## Перекрестные ссылки
На те ресурсы, которые мы копируем или перемещаем могут ссылаться другие ресурсы с помощью [перекрестных ссылок](./cross_reference.md).
При копировании ничего страшного не произойдет - ссылки на старый ресурс будут по-прежнему действительны.
А вот с перемещением не все так гладко.
Так как перемещенному ресурсу присваивается новый идентификатор, то все прежние ссылки на него становятся недействительными.
И если в своей системе еще можно обновить все ссылки, то кто знает где еще осели эти идентификаторы у клиентов API.

Но с этим ничего не поделать.
Клиенты должны быть готовы к тому, что ресурсы могут быть перемещены.

> А что если по предыдущему пути возвращать не 404 Not Found, а редирект 301 Moved Permanently на новый ресурс? 
> Это потребует хранения дополнительных данных, но зато у клиента будет возможность найти путь до ресурса.


---
## Метаданные родительских ресурсов
При копировании или перемещении ресурса от одного родительского ресурса к другому нас может подстерегать следующая проблема.
У родительского ресурса могут быть некоторые метаданные, ограничивающие инварианты дочерних данных.
Например, у ресурса _экзамен_ может быть поле метаданных _taskImageMaxBytes_, которое ограничивает размер изображений в дочерних ресурсах _заданий_ этого экзамена.

В случае нарушения условий, определяемых метаданными родительских ресурсов, лучше отклонять запрос на копирование или перемещение.

API может развиваться и дополняться, у родительских ресурсов могут возникать новые поля в метаданных, ограничивающих дочерние ресурсы.
И в этом случае нам потребуется дорабатывая методы создания дочерних ресурсов, так же дорабатывать и методы копирования.
Об этом очень легко забыть и в итоге получить некорректное поведение системы.
Так что стоит в очередной раз задуматься над необходимостью создания отдельных методов копирования и перемещения.


---
## Атомарность
Если скопировать или перенести одиночный ресурс не так сложно, то при наличии у него дочерних элементов задача усложняется в разы.
При копировании необходимо обеспечить атомарность.
Если у нас есть транзакционная БД, то необходимо делать копирование/перемещение в транзакции.
При этом могут возникать всевозможные странные артефакты в зависимости от настроенного уровня изоляции.
Блокировать данные на запись на время копирования точно не стоит, т.к. это открывает вектор атаки на систему.

В очередной раз стоит задуматься: а так ли нужны операции копирования и перемещения.


---
## К изучению
- [X] Книга "Паттерны проектирования API". Глава 17
