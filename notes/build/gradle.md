---
title: "Gradle"
tags:
  - build
draft: false
---

## Общие сведения

Gradle - сборщик и менеджер зависимостей для программного обеспечения.
Gradle позволяет собирать приложения на любом языке, но особенно популярен он для проектов на JVM-based языках.

В Java мире Gradle борется за внимание разработчиков с [Maven](maven.md). 
Gradle работает быстрее Maven благодаря инкрементальным билдам, которые позволяют не выполнять различные таски, которые выполнялись ранее.

Запуск задач Gradle можно производить с помощью IDE или CLI.
Вызов любой команды Gradle состоит из трех фаз:
- Инициализация - подготовка окружения к билду
- Конфигурация - строится граф тасок, определяется последовательность вызова тасок
- Выполнение - запускаются выбранные таски

Для отслеживания состояния билдов в Gradle есть специальный инструмент `build scans`.

Сборка проекта осуществляется в директорию `build`.

Gradle предоставляет возможно создавать различные задачи - таски и выстраивать их в графы зависимостей.

Главный файл, аналог `pom.xml`, в Gradle это `build.gradle`.
Описание процесса сборки проводится с помощью языков Groovy или Kotlin DSL.

Стандартные глобальные переменные:
- `project` - инстанс проекта
- `projectDir` - директория проекта
- `buildDir` - директория, в которую помещаются class-файлы и др. файлы, создающиеся при сборке проекта. Аналог `project.build.directory` из Maven.
- `path` - абсолютный путь к проекту


---
## Конфигурации

Стандартные конфигурации:
- `implementation`
- `api`
- `classpath`
- Устаревшие
  - `compile`

### Создание собственных конфигураций


---
## Таски

Таска - это какая-то работа, например компиляция каких-либо файлов, генерация документации или создание jar.
Таски можно писать самостоятельно.
Какие-то таски добавляются в проект при подключении плагинов.

Таски можно воспринимать как методы.
У них есть:
- входные данные
- выполняемые действия
- выходные данные

### Написание собственных тасок

<mark>todo</mark>

### Зависимости между тасками
Таски могут иметь зависимости друг от друга.
Например, запускать тестирование не имеет смысла, если код не скомпилирован, поэтому таска `test` имеет зависимость от таски `testClasses`, а та в свою очередь от таски `classes`.
Таким образом таски выстраиваются в направленный ациклический граф, где таска - это узел, а стрелка - это связь между тасками.

![gradle_default_tasks_dependencies](https://miro.medium.com/max/3336/1*E5JMRbW525OHTa1Op7dGGA.png)

Зависимости между тасками выражаются с помощью различных ключевых слов:
- `dependsOn` - для выполнения таски требуется предварительное выполнение другой таски
```groovy
test.dependsOn classes // таска test требует предварительного выполнения таски classes
```

- `mustRunAfter` - жестко устанавливает порядок выполнения двух тасок. При этом таски могут вызываться независимо друг от друга.
```groovy
task2.mustRunAfter task1 //при вызове двух тасок вторая всегда будет выполняться после первой
```

- `shouldRunAfter` - указывает Gradle, что таски желательно выполнять в указанном порядке.
```groovy
task2.shouldRunAfter task1 //при вызове двух тасок вторая чаще будет выполняться после первой
```

- `finalizedBy` - после выполнения данной таски должна быть выполнена другая таска
```groovy
task1.finalizedBy task2 //при вызове первой таски всегда будет выполнена вторая таска
```

### Отключение тасок

Самый простой способ не выполнять таску - выключить ее с помощью параметра `enabled`
```groovy
task1.enabled = false
```

Вызов таски может производиться только при удовлетворении какого-либо условия. Записывается это с помощью метода таски `onlyIf` в который необходимо передать предикат

```groovy
task1.onlyIf { !project.hasProperty('skipTask1') }
```

### Выполнение кода в тасках

На любой таске можно вызывать методы `doLast` и `doFirst`, исполняя какой-либо код.

<mark>//вставить код</mark>

### Параметры тасок

В таски можно добавлять параметры, которые будут доступны во всех местах, где эта таска вызывается. Делается это с помощью
```groovy
`ext`.
task taskName {
    ext.taskParam = "value"
}

task print {
    doLast {
        println taskName.taskParam
    }
}
```

### Результаты выполнения тасок

При запуске тасок в консоль выводятся результаты их выполнения:

- Нет примечания или `EXECUTED` - таска выполнена
- `UP-TO-DATE` - таска не выполнялась, потому что входные данные не изменились, а выходные уже были получены ранее
- `FROM-CACHE` - результаты выполнения таски были получены из кэша
- `SKIPPED` - таска не выполнялась, т.к. была намерено пропущена с помощью параметров запуска билда.
- `NO-SOURCE` - таска не выполнялась, потому что в ней отсутствовал код для исполнения

---
## Command Line Interface

Любые таски Gradle можно запускать из командной строки.

```shell
gradle clean build -x test
```

Ключ `-q` отключает вывод в командную строку логов, оставляя только то, что выводят в консоль таски.

### Gradle Wrapper
У разных разработчиков, работающих над одним проектом, могут быть установлены разные версии Gradle. 
Из-за этого у разных людей билд может проходить по-разному.
Чтобы у всех все было одинаково решили указывать конкретную версию Gradle сразу в проекте, а вызывать нужную версию с помощью скрипта.
Для этого в директории проекта должны быть файлы:
- `gradlew.bat` или `gradlew.sh` - основной исполняемый файл со скриптами
- `/gradle/wrapper/gradle-wrapper.properties` - основные настройки wrapper'а, здесь же указывается версия Gradle
- `/gradle/wrapper/gradle-wrapper.jar` - исходники gradle wrapper в виде Java-архива

Эти файлы можно выкачать с помощью команды (для этого должен быть установлен Gradle)
```shell
gradle wrapper
```
Будет выкачана версия Gradle Wrapper, соответствующая установленному Gradle.

Используемая версия Gradle указывается в настройке `distributionUrl` файла `gradle-wrapper.properties`.
Она будет выкачена в директорию `build/` проекта и в `wrapper/dists/` в директории с установленным Gradle.

Теперь из корня проекта можно запускать таски так же, как это делается для CLI, только первым словом будет обращение к файлу со скриптом:
```shell
./gradlew clean build -x test 
```


---
## К изучению
- [ ] [Документация](https://docs.gradle.org/current/userguide/getting_started.html) на Gradle
- [ ] Доклад [Евгений Борисов - Power of Gradle](https://www.youtube.com/watch?v=NZJTYPLb0iE&ab_channel=JUG.ru) 2013 г.
- [X] Что такое [Gradle Wrapper](https://medium.com/@bherbst/understanding-the-gradle-wrapper-a62f35662ab7)