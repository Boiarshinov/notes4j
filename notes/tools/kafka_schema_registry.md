---
title: "Kafka Schema Registry"
tags:
  - tool
  - kafka
  - specification
draft: True
---

# Schema Registry

__Schema Registry__ - база данных на основе [Kafka](./kafka.md), в которой хранятся схемы сообщений.
Поддерживаются схемы:
- [Protobuf](../formats/protobuf.md) - `.proto`
- Avro - `.avsc` 
- Json Schema - `.json-schema`
- можно расширять и другими схемами, но придется много всего сделать руками

Разворачивается в виде распределенного приложения с [REST](../web/rest.md) интерфейсом. 
Библиотеки продюсеров и консьюмеров имеют встроенных клиентов для обращения к Schema Registry. 

Особенно Schema Registry полезна, когда мы используем Kafka в качестве асинхронного публичного API, тогда пользователи API смогут узнать о формате сообщений из Schema Registry.
Например, к Kafka могут подключаться консьюмеры из других систем, разрабатываемых другими подразделениями (мониторинг, datalake и др.).
С помощью Schema Registry они узнают о формате сообщений и будут получать обновления форматов.

Schema Registry хранит схемы сообщений в Kafka в специальном системном топике `_schemas`, а также кэшируют их в памяти для быстродействия.

Schema Registry написана и поддерживается компанией Confluent и не находится под крылом Apache, в отличие от Kafka.

---
## Хранение схем
В Kafka, как правило в одном топике хранятся сообщения одного вида.
Сообщения характеризуются ключом и значением.
Ключ и значения имеют различную структуру, каждая из которых описывается с помощью схемы.
Схемы могут развиваться с течением времени, в них могут добавляться новые поля, старые поля могут депрекейтиться.
Внутри Schema Registry схема со всеми ее версиями живет в своем неймспейсе, который называется `subject`.

Рекомендуется именовать subject'ы по правилу `<имя топика>-key` и `<имя топика>-value`.
Существуют и другие стратегии именования subject'ов, например, по типу record'а или по связке имени топика и типу record'а.

Каждая схема получает свой уникальный schema id, который монотонно увеличивается для новых схем.
Когда схема добавляется в Schema Registry она получает номер версии `1`. 
Новая версия этой же схемы будет иметь тот же schema id и версию `2`.

Schema Registry хранит схемы сообщений в Kafka в специальном системном топике `_schemas`, а также кэшируют их в памяти для быстродействия.
Внутри Kafka этот топик имеет только одну партицию, чтобы обеспечивать упорядоченность схем.
Возможно поэтому Schema Registry имеет primary ноду, т.к. одну партицию может читать только один консьюмер.
Также этот топик компактенируется, т.е. хранит только последнее значение для каждого ключа.


---
## Интеграция

### Взаимодействие с Producer
Producer может быть сконфигурирован так, чтобы перед записью в Kafka, он отправлял в Schema Registry схему сообщения.
Schema Registry сравнивает полученную схему со схемой предыдущего сообщения и проверяет их совместимость.
Если обнаружена несовместимость, то Produser выкинет исключение.

Producer кэширует у себя схемы, полученные из Schema Registry, поэтому взаимодействие почти не влияет на производительность Producer'а.
Производительность может пострадать немножечко только при старте приложения, пока оно прогревается, ну и немножечко памяти отожрет хранение схем.

### Взаимодействие с Consumer
Consumer с помощью Schema Registry может сравнить совместимость схемы полученного сообщения, от ожидаемой.
И не обрабатывать сообщение, которое невозможно корректно десериализовать.

---
## REST API
Schema Registry предоставляет REST API для работы со схемами.
С помощью API можно зарегистрировать новую схему, обновить существующую и многое другое.

Разработчики Schema Registry используют генерацию [OpenAPI](../web/openapi.md) спецификации по коду, поэтому в официальной документации всегда можно найти актуальную спеку.

---
## Кластер
Чтобы Schema Registry не стала единой точкой отказа, ее можно развернуть в нескольких экземплярах.
Одна нода будет главной (_primary_), в случае ее выхода из строя нового лидера выбирает Zookeeper или Kafka.

---
## К изучению
- [ ] [Официальная документация](https://docs.confluent.io/platform/current/schema-registry/index.html)
- [ ] [Видео-курс от Confluent](https://developer.confluent.io/courses/schema-registry/key-concepts/)

