---
title: "Пароли"
tags:
  - security
draft: false
---

# Пароли

Пароль - это условное слово или произвольный набор знаков, предназначенный для подтверждения личности или полномочий.

Современным системам рекомендуется принимать в качестве паролей набор из любых символов юникода, а не только ascii символы.
Это может порождать странности поведения при использовании эмодзи, но даже если так - пользователь сам дурак, что использовал эмодзи в пароле.

Некоторые сервисы, например Сбербанк, принимают пароли в любом регистре.
То есть они считают, что `pAssWoRD` и `password` - это один и тот же пароль.
Это улучшает пользовательский опыт, особенно для людей, неуверенно взаимодействующих с компьютерами, но при этом ухудшает криптографическую стойкость паролей.

Вместо паролей могут использоваться пары публичных/приватных ключей.

---
## Хранение паролей

Ни в коем случае нельзя хранить пароли в открытом виде.

### Хэширование паролей
Хранить пароли зашифрованными - опасно, потому что шифрование - это обратимая операция.
Получив ключ, злоумышленник сможет расшифровать все пароли.
Так как хэш-функция - необратимая операция, то она отлично подходит для хранения паролей.
Пользователи часто используют один и тот же пароль на разных ресурсах.
Если злоумышленники узнают пароль из-за утечки в одном сервисе (например, сервис доставки CDEK), то они могут попробовать применить его в каком-нибудь другом сервисе, например, в банковском приложении или в социальной сети, и в итоге получить доступ к приватной информации или вывести деньги.

Хэш должен рассчитываться с помощью [криптографической хэш-функции](./crypto_hash_function.md).
Например, _argon2id_, _scrypt_, _pbkdf2_ (_bcrypt_ уже не рекомендуется к использованию).
Важное требование к хэш-функции - это трудозатраты.
Хэш-функция, использующаяся для хэширования паролей обязана быть трудоемкой, чтобы затруднить злоумышленникам перебор паролей.
Современные хэш-функции позволяют регулировать трудоемкость с помощью параметра __work-factor__.

Трудоемкость крипто-хэширования порождает новую уязвимость приложений - при достаточном количестве запросов на аутентификацию приложение может пустить все ресурсы сервера на расчет хэшей для проверки паролей (_denial of service_).
Поэтому важно ограничивать нагрузку на эндпойнты аутентификации.

Считается, что для пользовательских приложений общего назначения время расчета хэша не должно превышать одной секунды.


### Соль
При хэшировании к паролю должна добавляться случайная строчка, которая будет храниться рядом с хэшом.
Эта случайная строчка называется __солью__.
Многие пользователи имеют одинаковые пароли, даже не подозревая об этом.
Например, пользователь может придумать пароль, состоящий из его имени и даты рождения: `alex05011996`, но людей с таким именем и датой рождения может быть множество, и кому-то из них может прийти в голову та же идея.
И если не солить пароли перед хэшированием, то у двух одинаковых паролей получится одинаковый хэш.
Если злоумышленник узнает один пароль и его хэш, то получит доступ к аккаунтам еще множества пользователей с таким же паролем.

Перед хэшированием соль может как конкатенироваться к паролю, так и подмешиваться по более сложным алгоритмам.
Например, части соли вставляются в промежутки между символами пароля.

Хэширование может проводиться в несколько раундов.
К результату первого хэширования снова добавляется та же соль, и хэширование проводится еще раз.

### Перец
Вдобавок к соли перед хешированием к паролю может еще добавляться перец.
В отличие от соли перец является статическим, то есть одинаковым для всех пользователей.

Перец нужен для того, чтобы сделать невозможным определение паролей тем злоумышленникам, которые получили доступ только к базе данных с хэшами и солью, но ни к чему другому.
Так как перец хранят не в базе данных, а в защищенном хранилище (например, Vault), либо на худой конец в настройках приложения.

Добавление перца рекомендуется экспертами по безопасности, но не является обязательной процедурой.

### Обновление криптографических параметров
С течением времени, сообщество находит уязвимости в существующих алгоритмах хэширования, изобретает новые более совершенные алгоритмы, увеличиваются мощности железа и старые способы расчета требуется обновить.
Также, рекомендуют регулярно обновлять значение перца.

Для этого в приложениях должна быть предусмотрена процедура обновления параметров хэширования и пересчета хэшей.
Для этого может использоваться несколько подходов:
- все существующие хэши паролей могут быть захэшированы поверх с помощью новых более устойчивых параметров хэширования. 
  Например, если раньше пароли были захэшированы MD5 с использованием 5-символьной соли, то поверх этого хэша они могут быть перехэшированы с использованием argon2 и 256-битной соли: `argon2(md5($pwsd + $salt1) + $salt2)`.
  Старый хэш будет перезатерт, но потребуется хранить и старую и новую соль.
- Пользователи постепенно переводятся на новые параметры хэширования. 
  Одновременно должно поддерживаться сразу несколько версий расчета хэша.
  При очередном логине пользователя, если обнаруживается, что хэш его пароля рассчитан не по последнему писку моды, то после проверки пароля по старым параметрам, он пересчитывается по новым и данные пользователя обновляются.

Под параметрами хэширования подразумеваются:
- хэш-функция
- work factor хэш-функции
- значение соли
- значение перца
- ... могут быть и другие

При втором варианте может возникнуть проблема: что если пользователь давно не логинился в приложение, и вот наконец зашел, но его пароль был захэширован старой версией параметров, которая уже не поддерживается приложением.
В этом случае должна быть предусмотрена процедура восстановления аккаунта со сбросом пароля.

Можно комбинировать первый и второй вариант: сначала обернуть устаревший хэш новой хэш-функцией, а затем при перелогине пользователя пересчитать хэш с использованием только новых параметров хэширования.


### Пример структуры хранения паролей
```sql
create table user_auth (
    id bigint primary key,
    pswd_hash varchar(512) not null,
    pswd_salt varchar(512) not null,
    hash_version varchar(3) not null
)
```

### Хэширование паролей в веб-приложениях
В веб-приложениях хэшированием паролей и генерацией соли должен заниматься сервер, а не клиент.
Такой подход позволяет менять параметры хэширования и политики генерации соли на стороне сервера.
На стороне клиента провести обновление параметров хэширования было бы намного тяжелее.

---
## К изучению

- [X] [Рекомендации OWASP](https://cheatsheetseries.owasp.org/cheatsheets/Password_Storage_Cheat_Sheet.html) по хранению паролей
- [X] [Результаты соревнования хэш-функций для паролей](https://www.password-hashing.net/) (Спойлер: победил argon2)
- [X] [Криптографическая соль. Wiki](https://ru.wikipedia.org/wiki/%D0%A1%D0%BE%D0%BB%D1%8C_(%D0%BA%D1%80%D0%B8%D0%BF%D1%82%D0%BE%D0%B3%D1%80%D0%B0%D1%84%D0%B8%D1%8F))
