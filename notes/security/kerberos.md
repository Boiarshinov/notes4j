---
title: "Kerberos"
tags:
  - security
draft: false
---

# Kerberos

__Kerberos__ - это протокол взаимодействия, обеспечивающий безопасность при общении двух акторов.

Kerberos основан на симметричных алгоритмах шифрования.

Поддержка Kerberos есть во всех современных операционных системах.
Существует две активные версии Kerberos: v4 и v5. Пользоваться нужно текущей версией v5, т.к. она поддерживает различные типы шифрования.

- Kerberos Realm - это группа сервисов, для которых Kerberos может аутентифицировать пользователей.
- Principal - уникальный идентификатор пользователя или сервиса.
- Key Distribution Center (KDC) - ядро Kerberos, состоящее из двух сервисов:
  - Authentication Server - аутентифицирует пользователя в системе. Выдает ticket granting ticket
  - Ticket Granting Server (__TGS__) - проверяет, что запрос идет на существующий сервис. Выдает service ticket

Authentication Server хранит у себя данные о пользователях вместе с их секретными ключами (секретными или публичными?).

Виды сообщений:
- `Authenticators`
- `Tickets`
  - __TGT__ - Ticket granted ticket - сообщение, содержащее в себе сессионный ключ. TGT шифруется на секретном ключе TGS
  - __Service Ticket__ - сообщение, содержащее в себе сессионный ключ для общения с сервисом. Service Ticket шифруется на секретном ключе сервиса

![kerberos sequence diagram](../../images/src/kerberos.uml)

Порядок общение сервисов между собой:
- Клиент обращается к Authentication Server, передавая ему свой id, id сервиса, с которым он хочет начать взаимодействие, свой IP-адрес и желаемый срок действия TGT
- Authentication Server отвечает клиенту двумя сообщениями: в первом он высылает сессионный ключ для общения с TGS, а во втором зашифрованный TGT. Сам клиент не может расшифровать TGT и не должен, т.к. он зашифрован на ключе TGS и предназначен для него
- Клиент обращается к TGS с помощью двух сообщений:
первое нешифрованное и содержит идентификатор сервиса, к которому клиент хочет получить доступ, второе зашифрованное на сессионном ключе TGS, называемое User Authenticator. К этим двум сообщениям прикладывается шифрованный TGT
- TGS расшифровывает TGT и проверяет аутентификацию пользователя
- TGS высылает клиенту Service Ticket, зашифрованный на секретном ключе сервиса, и сессионный ключ для общения с сервисом.
- Клиент шифрует на сессионном ключе cообщение User Authenticator и направляет его сервису вместе с Service Ticket.
- Сервис валидирует Service Ticket и высылает клиенту свое аутентифицирующее сообщение Service Authenticator.


---
## Конфигурация

Для создания конфигурационных файлов и манипуляции с ними используются консольные утилиты, входящие в пакет `krb5-user`: `ktutil`, `klist` и другие.

### Клиент
На хосте клиента должен быть представлен файл `/etc/krb5.conf`, в котором описывается подключение к серверам Kerberos.
Цифра `5` отвечает за версию Kerberos.

Также на хосте должны быть файлы с расширением `.keytab`, в которых прописываются долговременные ключи для принципала.
Keytab представляет собой таблицу, в которой прописаны принципалы, возможные виды шифрования, дата добавления ключа в файл и пр.


---
## К изучению
- [ ] [Официальная документация](https://web.mit.edu/kerberos/krb5-1.12/doc/index.html)
- [X] [Аутентификация в Kerberos](https://www.youtube.com/watch?v=5N242XcKAsM&ab_channel=DestinationCertification). 16:51