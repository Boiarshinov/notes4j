---
title: "Внедрение значений из файлов конфигураций в Spring"
tags:
  - spring
  - spring_boot
draft: false
---

# Внедрение значений из файлов конфигураций в Spring

Частенько бывает нужно иметь возможность менять конфигурацию приложения без его перекомпиляции.
Например, для выкатки приложения на различные среды: прод, тестовый стенд, стенд разработки.
На средах могут различаться хосты внешних сервисов, баз данных и прочего.
Также иногда хочется уметь подкрутить параметры приложения без выкатки нового релиза, например, параметры ретраев к внешним сервисам, параметры регулярных джоб и пр.

Такие параметры можно определять в отдельных файлах.
Это могут быть [properties-файлы](../java/properties.md) или yaml.


## Возможности Spring

Для того чтобы считать данные из файла, необходимо указать Spring на файл конфигурации с помощью аннотации `@PropertySource`.
В параметры аннотации нужно сослаться на файл, который обычно кладется в директорию `/resources` приложения.
Эта аннотация должна использоваться в паре с аннотацией `@Configuration`, поэтому рекомендуется выносить все что связано с выгрузкой данных из конфигурационного файла в отдельный класс.
```java
@Configuration
@PropertySource("classpath:restClientConfig.yml")
public class RestClientConfig { /* */ }
```

> Примечание - для подгрузки файлов с текстами каких-либо сообщений для разных локалей обычно используется `ResourceBundleMessageSource`.

В результате Spring прочитает этот файл, и загрузит в память приложения настройки в формате ключ-значение.
Теперь, чтобы использовать эти настройки, нужно их как-то достать.
Есть несколько способов:
- Через абстракцию `Enviroment`
- Через аннотации `@Value`


### `Enviroment`
Абстракция `Enviroment` служит для того, чтобы представлять две вещи: профили и настройки.
Про профили здесь не будем говорить, про них есть [отдельная заметка](profiles.md).

> Можно вместо `Enviroment` пользоваться его родительским интерфейсом `PropertyResolver`.
> В нем нет методов, связанных с профилями.
> К сожалению, на него ругается Intellij IDEA (совершенно беспочвенно), из-за чего использовать его неприятно

`Enviroment` - это интерфейс. 
В Spring контексте автоматически будет создан экземпляр бина, который реализует этот интерфейс.
Мы можем заинжектить в любой компонент этот бин и вытащить из него необходимые настройки:
```java
public RestClientConfig(@Autowired Environment env) {
    this.host = env.getProperty("restclient.catsService.host");
    this.timeout = env.getProperty("restclient.catsService.timeout", Duration.class);
    this.retryCount = env.getProperty("restclient.catsService.retryCount", Integer.class, 3);
}
```
Настройки достаются по названию. 
Они могут быть примитивных типов, строками, перечислениями, объектами `Duration` из [Date Time API](../java/time/datetime_api.md) и др.
Также можно указать значение по умолчанию, которое будет применено, если в файле такой настройки нет.

Важно, чтобы настройки в разных конфигурационных файлах имели разные наименования. 
Иначе они могут перекрывать друг друга и будет сложно предсказать какая из них сработает.
Для того чтобы этого избежать используют телескопические наименования настроек.
Обычно конфигурационные файлы выглядят так:
```yml
restclient:
  catsService:
    host: "https://cats.ru"
    timeout: 10s
    retryCount: 5
```


### `@Value`

Доставать значения из файла еще можно с помощью аннотации `@Value`, в которой передается название настройки.
При этом имя ключа оборачивается в `${keyName}`.
Синтаксис очень поход на [Expression Language](../jsp/expression_language.md) из JSP.
```java
@Value("${restclient.catsService.timeout}")
private Duration timeout;

@Value("${restclient.catsService.host}")
private String host;

@Value("${restclient.catsService.retryCount}")
private int retryCount;
```


## Возможности Spring Boot

Писать в каждой аннотации `@Value` одинаковое начало для всех настроек так утомительно!
Еще и название настройки соответствует названию ее ключа в файле конфигурации.
Ах вот бы ничего не нужно было бы писать!

Spring Boot дает такую возможность.
Для этого предназначена аннотация `@ConfigurationProperties`.
Она вычитывает параметры с указанным префиксом из стандартного файла конфигурации `application.properties` / `application.yml` и записывает значения в поля с соответствующими наименованиями.

```java
// По неизведанным причинам prefix нужно записывать полностью в нижнем регистре
@ConfigurationProperties(prefix = "restclient.catsservice")
public class RestClientProps {

    @NotBlank
    String host;
    
    @NotNull
    Duration timeout;
    
    @PositiveOrZero
    int retryCount;

    Duration rateLimiter = Duration.ofMillis(500L); //Значение по умолчанию
}
```

При этом еще и поддерживаются аннотации [Bean Validation](../java_ee/bean_validation.md).
Соответствие им будет проверяться автоматически при создании экземпляра класса.
Если будет обнаружено несоответствие, то приложение не стартанет.



---
## К изучению
- [X] javadoc на упомянутые классы
- [X] Книга Java в облаке. Глава 3
- [X] Baeldung. [Статья про ConfigurationProperties](https://www.baeldung.com/configuration-properties-in-spring-boot)