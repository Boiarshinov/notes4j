---
title: "Java Memory Model"
tags:
  - internal
  - multithreading
draft: false
---

# Java Memory Model

__Java Memory Model__ (JMM) - это набор гарантий, который предоставляет JVM.
Благодаря этим гарантиям разработчик может не делать дополнительных проверок при написании многопоточного кода.

Гарантии:
- все примитивы (кроме long и double) и ссылки читаются и пишутся атомарно
- если поток не взаимодействует с другими потоками и общими переменными, то на него не влияет работа других потоков
- только один поток единовременно может захватить блокировку
- обновления volatile переменной видны сразу
- при вызове `tread.start()` сначала создается новый поток JVM и только потом начинают выполняться действия внутри него
- если поток присоединился через `thread.join()`, значит он точно завершился
- если `thread.isAlive() == false`, значит поток точно завершился
- деструктор не может запуститься раньше конструктора
- транзитивность: если A произошло перед B, а B перед C, то A произошло раньше C.
- если переменная не проинициализирована, то она содержит значение по умолчанию. `0`, `false` или `null`.

Все классы в `java.util.concurrent` написаны с учетом гарантий JMM.
Если разработчик пишет свои утилиты для работы с многопоточкой, то он должен соблюсти все гарантии самостоятельно.


Нет гарантий:
- несогласованные изменения. Если два потока одновременно работают с общими переменными на чтение и запись, то недетерменировано какое значение увидит один из потоков в конкретный момент времени
- изменения общей переменной могут быть не видны другим потокам
- поля нового объекта не видны потоку

Для того чтобы избежать этих проблем, необходимо _синхронизировать_ доступ к общим переменным.
Синхронизация дает следующие гарантии:
- атомарность изменений
- видимость изменений
- безопасность публикации

Про синхронизацию подробно написано в заметке о [потокобезопасности](./threadsafe.md).


---
## Happens Before
JVM может переставлять исполнение строчек кода между собой при исполнении, если считает, что это не отразится на результате.
При этом есть несколько правил, которые однозначно указывают, что одна операция исполнится раньше другой.
Эти правила называются __happens before__.

- выход одного потока из synchronized блока _happens before_ вход другого потока в этот блок на том же мониторе
- запись в `volatile` переменную _happens before_ чтения из нее
- создание потока _happens before_ выполнения кода в методе `run()` этого потока



---
## К изучению
- [X] [Курс по многопоточности в Java](https://fillthegaps.getcourse.ru/mt7)
- [ ] [FAQ по JMM (JSR 133)](http://www.cs.umd.edu/~pugh/java/memoryModel/jsr-133-faq.html)
- [ ] Лекции А. Шипилёва JMM Pragmatics. [Часть 1](https://www.youtube.com/watch?v=noDnSV7NCtw&ab_channel=jeeconf), [часть 2](https://www.youtube.com/watch?v=Ky1_5mabd18&ab_channel=jeeconf)