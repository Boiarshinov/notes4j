---
title: "Date Time API"
tags:
  - time
draft: false
---

Из-за недостатков [стандартных классов](date_calendar.md) `Date` и `Calendar` в Java 8 была обновлена библиотека для работы со временем. Все классы новой библиотеки хранятся в пакете `java.time`.

Библиотека была добавлена в Java путем адаптации популярной либы Joda Time. Работа по созданию библиотеки проводилась в рамках JSR-310.

Все классы нового API являются неизменяемыми и потокобезопасными.

---
## Временные зоны

Для представления временных зон существует абстрактный класс `ZoneId` с двумя наследниками:

- `ZoneOffset` - простое смещение относительно UTC. Такое смещение может однозначно определить точку на временной оси, но не может использоваться для расчетов разницы между различными временными точками, из-за того что в одной и той же точке на карте Земли законодательно или при переходе с летнего времени на зимнее и обратно могут меняться смещения относительно UTC.
- `ZoneRegion` - смещение, привязанное к географической зоне. Записывается в виде `Europe/Minsk`. Так как таймзоны различных регионов различных стран постоянно меняются, необходимо обновлять для своего приложения Time Zone Database (TZDB).

---
## Часы Clock

Часы используются для определения текущего времени. В новой библиотеке часы представлены классом `Clock`. Класс является абстрактным и для создания экземпляров используются статические методы генерации.

Если раньше для получения текущего значения времени все использовали метод `System.currentTimeMillis()`, то теперь можно пользоваться `Clock.instant()`, который возвращает текущее время в наносекундах, что в миллион раз точнее.

Все методы `now()` остальных классов библиотеки используют `Clock` для определения текущего времени.

### Тестирование

Класс `Clock` редко используется в продакшен коде, но может быть использован в тестах для мокирования создания времени других классов, которые на нем основаны.

Для тестирования рекомендуется в продакшен коде инжектить в свои бины класс `Clock` и при создании экземпляров других классов библиотеки пользоваться методом `now(clock)`. Таким образом в тестах можно будет передать в тестируемый бин правильно замокированный `Clock`.

---
## Мгновение

Вместо класса `Date` с названием, не отражающим его назначение, в новой библиотеке времени используется класс `Instant`, который представляет собой фиксированную метку на шкале времени. Этот класс ничего не знает о временных зонах.

Для хранения времени в наносекундном диапазоне внутри класса `Instant` используются две переменные: одна int для хранения значения наносекунд, а вторая long для хранения секунд с рождения компьютеров (полночь 01.01.1970 или EPOCH_DAY).

Объекты класса `Instant` генерируются с помощью

---
## Дата и время, не учитывающие таймзону

Классы, отражающие дату и / или время какой-либо точки на временной шкале и не учитывающие таймзону, могут использоваться в приложениях, в которых работа с таймзонами консистентна: например, если есть договоренность, что все времена хранятся в одной таймзоне, чаще всего в UTC.

Если же консистентности нет, то лучше пользоваться классами, учитывающими таймзоны.

Так как все классы нового API являются неизменяемыми, то для того чтобы получить новый объект на основе старого с изменными полями используются методы, начинающиеся с `with`, `plus` и `minus`.

### Время

Для представления времени используется класс `LocalTime`.  Он инкапсулирует в себе часы, минуты, секунды и наносекунды.

Объекты этого класса никак не привязаны к таймзонам, а значит не могут использоваться для точного определения точки на временной оси.

### Дата

Для представления дат используется класс `LocalDate`.

Объекты этого класса никак не привязаны к таймзонам, а значит не могут использоваться для точного определения точки на временной оси.

### Дата и время

Очень часто в приложениях для представления временной отметки какого-либо события используется комбинация даты и времени, представленной классом `LocalDateTime`.

Объекты этого класса никак не привязаны к таймзонам, а значит не могут использоваться для точного определения точки на временной оси.

---
## Дата и время, учитывающие таймзону

Самое полное представление даты и времени с учетом таймзоны предоставляет класс `ZonedDateTime`.

Не совсем полное представление имеют классы `OffsetDateTime` и `OffsetTime`, которые инкапсулируют в себе соответствующие локальные классы и `ZoneOffset`.

---
## Другие временные сущности

### Прочие временные сущности

Помимо дат и времени, существуют менее полные временные сущности, представленные своими классами:

- `Month` - перечисление, отражающее месяц
- `DayOfWeek` - перечисление, отражающее день недели
- `Year` - год
- `MonthDay` - комбинация месяца и дня
- `YearMonth` - комбинация года и месяца

### Временной промежуток

Разница между двумя отметками времени на временной оси выражается с помощью класса `Duration`.

Разница хранится в виде количества секунд и наносекунд.

Для корректного вычисления разницы между двумя временами, каждое из них должно иметь данные о таймзоне. Поэтому проводить вычисления `Duration` с `LocalDateTime` - опасно. Для этого нужно использовать `OffsetDateTime`.

Для получения разницы между двумя временными точками используется метод `between()`:

Duration oneDay = Duration.between(today, yesterday);

### Дневной промежуток

Для описания промежутка между двумя датами используется класс `Period`.
Класс инкапсулирует в себе год, месяц и день.

### Единицы измерения

Единицы измерения времени представлены в перечислении `ChronoUnit`.

Зачастую объекты этого перечисления используются, чтобы прибавить или вычесть определенный промежуток времени из какого-либо временного объекта:

final LocalDate localDate = LocalDate.now().plus(5, ChronoUnit.DAYS);

### Календари

В Date Time API существует несколько видов календарей: григорианский (ISO-8601), японский, буддистский и др. Все календари реализуют интерфейс `Chronology` и хранятся в пакете `java.time.chrono`.

В большинстве приложений используется григорианский календарь, используемый библиотекой по умолчанию.

---
## Форматирование

Для форматирования дат и времени используется класс `DateTimeFormatter`.

У класса есть несколько предустановленных форматов, но при необходимости можно описать свой формат вывода времени (или приема) с помощью строк со [специальным синтаксисом](date_calendar.md).
```java
private static final DateTimeFormatter DATE_TIME_FORMATTER = DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss");
```

---
## Совместимость со старым API

Для перевода старых представлений временных точек используются методы, добавленные в старый API:
```java
Instant instant = new Date().toInstant();
```

---
## Общие рекомендации

Любые попытки совершения противоправных действия порождают `DateTimeException`. Обрабатывать такие исключения ни в коем случае не нужно. В правильно составленных действиях с временем такие исключения выбрасываться не будут. Для того чтобы быть уверенным в том, что это исключение не будет выброшено в вашей программе, следует на все методы, оперирующие с датами писать модульные тесты.

Для упрощения себе жизни в приложениях всегда стоит устанавливать дефолтную таймзону. Делается это обычно на старте приложения следующим образом:
```java
TimeZone.setDefault(TimeZone.getTimeZone(ZoneOffset.UTC));
```

Принимать отметки времени от клиента в большинстве случаев лучше вместе с таймзоной, указанной в отклонении от UTC. Подробнее о причинах см. статью "Правильная работа с датой и временем".

---
## Интеграции

### Базы данных

Для хранения отметок времени в реляционных базах данных стандартом SQL предусмотрены свои типы данных. Об этих типах и о маппинге классов Date Time API на типы SQL см. заметку [JPA. Соответствие типов](../../jpa/jpa_type_matching.md).

### JSON

Для использования при сериализации и десериализации в JSON и из него классов новой библиотеки необходимо правильно сконфигурировать Jackson. В версии 3 обещают добавить использование нужного модуля работы со временем по умолчанию, но пока приходится делать это вручную:
```java
@Configuration
public class JacksonConfig {
    @Bean
    public ObjectMapper jsonMapper() {
        final ObjectMapper mapper = new ObjectMapper();
        mapper.registerModule(new JavaTimeModule());
        /* другие настройки Jackson */
        return mapper;
    }
}
```

---
## К изучению
- [ ] Javadoc на `java.time`
- [X] Краткий обзор библиотеки от Oracle: https://www.oracle.com/technical-resources/articles/java/jf14-date-time.html
- [X] Сверхполная статья о библиотеке на Хабре: https://habr.com/ru/post/274905/
- [X] Правильная работа с датой и временем (без привязки к Java): https://habr.com/ru/post/278527/
- [X] Как правильно работать с таймзонами: https://habr.com/ru/company/mailru/blog/242645/
- [ ] JSR-310: https://jcp.org/en/jsr/detail?id=310