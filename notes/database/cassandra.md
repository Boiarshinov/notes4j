---
title: "Apache Cassandra"
tags:
  - database
  - nosql
  - java_and_db
  - distributed_system
draft: false
---

# Apache Cassandra

Apache Cassandra - это распределенная NoSQL база данных.

Apache Cassandra для запросов использует специальный язык CQL, похожий на SQL.

Традиционно Cassandra считается AP системой в терминах CAP-теоремы.
Хотя благодаря возможности задания уровня консистентности (см. ниже) для каждого запроса, в некоторых случаях она может становиться CP-системой.

Apache Cassandra развивается под крылом Apache Software Foundation, но ее основным мейнтейнером является компания DataStax.

Из известных компаний используют Apache Cassandra:
- Instagram
- Netflix (10'000 нод в 100 кластерах)
- Apple (150'000 нод)
- GitHub


## Распределенность

Apache Cassandra развертывывается в виде кластера нод. 
При этом нет единой точки отказа, все ноды являются равноценными.
Такие системы также называют masterless.
Ноды Cassandra объединяются в кольца, когда каждая нода взаимодействует только с двумя соседними.

Ноды всегда знают о состоянии кластера.
Ноды передают информацию о состоянии друг друга с помощью gossip protocol.
Для синхронизации данных между нодами в Cassandra используется PAXOS.

Для того чтобы данные не пропадали при выходе из строя одной из нод, есть некоторая избыточность в хранении данных.
На скольки серверах будут отреплицированны данные определяется настройкой replication factor.
Рекомендуемое значение replication factor - 3 или 5.
Четные значения не рекомендуются, т.к. при них кворум будет избыточным.
Единичный кусок данных, который будет реплицироваться на другую ноду, называется партицией. 

Когда запрос на запись приходит на любую из нод, она определяет в каких нодах располагается запрашиваемая партиция и перекидывает данные туда.
Т.е. все ноды имеют информацию о том, как распределены партиции по остальным нодам.
Нода, принявшая запрос, называется нодой-координатором.
Если одна из нод держателей партиции недоступна, то нода-координатор записывает себе, что нужно будет отреплицировать данные в нее, когда она поднимется.

При добавлении новой ноды в кластер или выводе ноды из кластера данные перераспределяются между нодами.
Происходит перебалансировка кластера.
Рекомендуется ноды вводить/выводить постепенно, чтобы не создавать излишнюю нагрузку на сеть.

Cassandra позволяет синхронизировать данные между кластерами, которые находятся в разных датацентрах (ЦОДах).
Для этого нода-координатор, принявшая запрос, реплицирует его на любую ноду другого кластера.

### Consistency level
В каждом запросе к Cassandra есть специальный элемент - уровень консистентности (`consistency level`).
Уровень консистентности определяет количество нод, от которых нужно дождаться ответа, чтобы считать запрос выполненным.
Возможные значения уровня консистентности:
- `ANY` - если запрос достиг координатор-ноды, то он уже считается обработанным. Не рекомендуется к использованию
- `ONE`, `TWO`, `THREE` - достаточно ответа от одной / двух / трех нод
- `QUORUM` - достаточно ответа от большинства нод, обслуживающих партицию. Для `replication factor = 3`, кворумом будет считаться 2 ноды. Для двух ЦОД с тем же фактором репликации, кворумом будет считаться 4 ноды.
- `LOCAL_QUORUM` - достаточно ответа от большинства нод, обслуживающих партицию на данном ЦОД. Для `replication factor = 3` и любом количество ЦОДов, кворумом будет считаться 2 ноды
- `EACH_QUORUM` - достаточно ответа от большинства нод, обслуживающих партицию на всех ЦОДах при записи. При чтении достаточно локального кворума
- `ALL` - нужен ответ от всех нод, обслуживающих партицию

По умолчанию Cassandra использует `QUORUM` и для операций на чтение, и для операций на запись.

### Драйвер
Драйвер - это библиотека, которая подключается к приложению и позволяет взаимодействовать с Apache Cassandra (JDBC драйвер???).

Драйвер при установлении соединения с кластером выгружает информацию о том, на каких нодах располагаются какие партиции данных.
Благодаря этому запросы будут идти на те ноды, на которых лежат нужные данные.


## Принцип работы с памятью

Когда в Cassandra приходит запрос на запись, первым делом координатор-нода записывает его в файл, называемый commit log. 
Commit log - это append only файлик, в который данные записываются всегда в конец.
Затем данные попадают в memtable - это структура, которая хранится в оперативной памяти ноды.
Для каждой записи Cassandra проставляет таймстемп, когда запись попала в ноду.
С некоторой периодичностью данные из memtable записываются в специальные файлы - SSTable, а память освобождается под новые записи.

Также регулярно проводится объединение отдельных sstable, при котором из файлов удаляются устаревшие данные.
Этот процесс называется **компакцией**.

Удаление в Cassandra - это новая запись, которая идет со специальным маркером.
Т.е. событие удаления записывается в commit log, затем в memtable, потом попадает в sstable, и только при компакции данные будут действительно удалены.
Такая логика работы может приводить к неожиданному поведению - сразу после запроса на удаление свободное дисковое пространство уменьшается и освободится только спустя какое-то время.

Обновление - тоже новая запись.
При этом запись может первоначально попасть не в ту sstable, в которой находилось предыдущее значение обновляемой сущности.
При компакции sstable'ов актуальное значение сущности среди различных ее версий выбирается по значению таймстампа.

При запросе на чтение Cassandra вычитывает все sstable, которые относятся к запрашиваемой партиции, ищет необходимую запись и при необходимости мержит результат.



## Модель данных

В Cassandra на верхнем уровне хранения данных стоит Keyspace - это аналог схемы в реляционных БД.
В одной Keyspace может быть несколько таблиц.
Таблица очень похожа на реляционную таблицу. 
Столбцы - это атрибуты, а строки - конкретные записи.

### Partition key
Один (или несколько вместе) из столбцов должен являться partition key - ключом партиции.
Выбор ключа партиции очень важен, т.к. именно по нему данные в таблице дробятся на партиции и реплицируются.
Т.е. данные по различным значениям ключа должны быть распределены равномерно, иначе какие-то ноды будут нагружены очень сильно, а другие будут прохлаждаться.


## CQL

CQL - Cassandra Query Language


---
## К изучению

- [ ] [Воркшоп от dev advocate Apache Cassandra](https://www.youtube.com/watch?v=Ae4GABykRoM&t=25s&ab_channel=DataStaxDevelopers)