---
title: "Репликация"
tags:
  - database
draft: false
---

# Репликация

Все последующие данные актуальны для PostgreSQL, возможно для других СУБД все работает не так.

У БД может быть несколько серверов:
- **мастер-сервер** (ведущий, главный - master / primary) - данные в нем можно писать и читать.
- **сервер-реплика** (ведомый, резервный - standby / secondary) - в него просто дублируются данные из мастера.
- **теплый сервер** (warm standby) - в него дублируются данные из мастера, при падении мастера теплый сервер заменяет его.
- **горячий сервер** (hot standby) - в него дублируются данные из мастера. Из него можно читать данные (но нельзя писать).

Репликация данных может быть синхронной и асинхронной:
- **синхронная** - в этом случае все транзакции на запись не считаются завершенными, пока все сервера не подтвердили транзакцию.
- **асинхронная** - в этом случае транзакция на запись подтверждается только мастером, который затем передает журнал с изменениями данных по остальным серверам.

В случае асинхронной репликации может возникнуть неконсистентность данных между мастером и другими серверами, потому что подчиненные серверы еще не успели применить изменения, переданные мастер-сервером.

Такая неконсистентность называется **лагом репликации**.

Также при асинхронной репликации в случае падения мастер-сервера некоторые данные могут быть потеряны вовсе.

Синхронная репликация плохо подходит для высоконагруженных web-приложений, у которых одновременно может быть множество запросов как на чтение, так и на запись.

У всех серверов должна быть одинаковая мажорная версия СУБД postgreSQL, иначе трансляция журналов невозможна.

Желательно чтобы минорная версия СУБД на серверах также совпадала, при этом рекомендуется обновлять сначала резервные серверы и только потом мастер-сервер.

---
## Потоковая репликация

Потоковая репликация по умолчанию к асинхронным. Но ее можно настроить так, что она станет синхронной.

В потоковой репликации задействованы следующие процессы:

- **WAL Sender** на стороне мастера, который занимается отправкой журнала изменений в реплики. Для каждой реплики запущен свой процесс WAL Sender.
- **WAL Receiver** на стороне реплики. Этот процесс принимает журналы транзакций от мастера и передает их в третий процесс:
- **Startup process** на стороне реплики, который читает журналы транзакций и воспроизводит на данных все изменения, описанные в журнале.

![](https://habrastorage.org/webt/ek/g2/rd/ekg2rdtwkvfjw8hlpj0rhhzhogu.jpeg)

Лаг репликации - ситуация, когда один и тот же запрос, выполненный на мастере и на реплике, возвращает различные данные.

Это означает, что реплика отстает от мастера, т.к. не успевает воспроизвести журналы транзакций.

---
## К изучению:

- [ ] Официальная документация PostgreSQL по репликации (для версии 10): https://postgrespro.ru/docs/postgresql/10/high-availability
- [ ] Решение проблем репликации PostgreSQL: https://habr.com/ru/company/oleg-bunin/blog/414111/
- [ ] В общем о репликации (MySQL): https://ruhighload.com/%D0%A0%D0%B5%D0%BF%D0%BB%D0%B8%D0%BA%D0%B0%D1%86%D0%B8%D1%8F+%D0%B4%D0%B0%D0%BD%D0%BD%D1%8B%D1%85