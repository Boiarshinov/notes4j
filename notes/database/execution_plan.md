---
title: "План запроса"
tags:
  - database
  - sql
draft: false
---

# План запроса

План запроса - это порядок выполнения сложного запроса, включающий в себя информацию об использовании индексов.

Для просмотра плана запроса необходимо написать перед запросом ключевое слово `EXPLAIN`.

При построении плана запроса сам запрос не исполняется.

Запрос разбивается на последовательность действий, выполняемых один за другим. Каждое такое действие называется **узлом плана**.

Параметры производительности:
- `cost` - стоимость выполнения запроса. Оценивается в попугаях. Стоимость выполнения внешних узлов плана включает в себя стоимость выполнения внутренних узлов.
- `rows` - ожидаемое количество кортежей, по которому должен пройтись этот узел плана.
- `width` - средний размер кортежа в байтах

### Анализ реального запроса

Для того чтобы посмотреть, как будет выполняться запрос на реальных данных, необходимо после EXPLAIN в скобках прописать ключевое слово `ANALYZE`. При этом запрос будет выполнен.

При запуске запроса с этим ключевым словом профилировщиком будут выведены дополнительные данные:

- для каждой операции:
    - `actual time` - реальное время, затраченное для выполнения части запроса.
    - `loops` - сколько раз пришлось выполнить операцию.
    - `rows` - реальное количество полученных строк.
- общие данные:
    - `planning time` - время, потраченное на составление плана запроса. ???
    - `execution time` - общее время выполнения запроса.

Если необходимо провести профилировку запроса, изменяющего данные, то необходимо откатывать его после исполнения с помощью команды `ROLLBACK`.

### Значения терминов

- `Gather` - ?
- `Seq Scan` - последовательное сканирование всех элементов в таблице
- `Parallel Seq Scan` - последовательное сканирование всех элементов в таблице, разбитое на несколько тредов (но это не точно)
- `Bitmap Heap Scan` - сканирование по результатам выборки Bitmap Index.
- `Bitmap Index Scan` - сканирование по индексу, которое включает в себя построение битовой маски.
- `Index Scan` - сканирование с использованием индекса. Используется при наличии в запросе условий `WHERE` или `ON` при джойне таблиц.
- `Index Only Scan` - то же, что и `Index Scan`, но читает значения не всего кортежа, а только атрибута, на котором стоит индекс. Поэтому он выполняется быстрее чем `Index Scan`.
- `Filter` -
- `Join Filter` -
- `Hash [Left / Right] Join` - джойнит таблицы, сравнивая хэши значений внешнего ключа и первичного ключа (или по чему они там будут джойниться)
- `Merge [Left / Right] Join` -
- `Nested Loop` -
- `BitmapAnd` - операция объединения результатов двух `Bitmap Index Scan` с помощью логического `И`.
- `Recheck Cond` - перепроверка условия, по которому уже проходила фильтрация ранее.
- `Index Cond` -
- `Hash Cond` - условие джойна таблиц по хэшу
- `Merge Cond` -
- `Sort` - сортировка выборки. Используется, когда в запросе есть `ORDER BY`.

---
## К изучению

- [ ] Документация на EXPLAIN в PostgreSQL: https://postgrespro.ru/docs/postgresql/10/using-explain
- [X] Оптимизация запросов. Основы EXPLAIN в PostgreSQL. Часть 1: https://habr.com/ru/post/203320/
- [X] Оптимизация запросов. Основы EXPLAIN в PostgreSQL. Часть 2: https://habr.com/ru/post/203386/
- [X] Оптимизация запросов. Основы EXPLAIN в PostgreSQL. Часть 3: https://habr.com/ru/post/203484/
- [X] Вся правда об индексах в PostgreSQL. Видео: https://www.youtube.com/watch?v=aaecM4wKdhY