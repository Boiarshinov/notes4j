---
title: "Load balancer"
tags: 
  - architecture
draft: true
---

# Load balancer

Load balancer - балансировщик нагрузки - система, отвечающая за распределение нагрузки по нескольким инстансам приложения.

Применение балансировщиков дает следующие преимущества:
- Scalability - можно поднять дополнительные инстансы серверов при увеличении нагрузки.
- Availability - если упадет один из инстансов, то балансировщик перестанет направлять ему запросы.
- Flexibility - можно изменить местоположение инстансов.
- Secutiry - благодаря балансировщикам можно не раскрывать устройство системы, количество инстансов и пр. Также балансировщики могут брать на себя дополнительные обязанности по проверке сертификатов пользователей, первичной аутентификации и другие функции.

Балансировщики бывают следующих видов:
- __server-side__ - на стороне сервера перед инстансами сервиса устанавливается отдельное приложение Балансировщик, которое перенаправляет запросы между инстансами.
    <mark>todo add image</mark>
- __client-side__ - клиент сам распределяет запросы между инстансами
  - с service discovery - клиент получает список инстансов из отдельного серверного приложения Service Discovery
      <mark>todo add image</mark>
  - без service discovery - клиент знает все инстансы сервисов заранее. При таком подходе каждое добавление инстанса будет требовать обновления настроек клиента.

Client-side обычно не используется в публичных API. 
Но часто используется в микросервисной архитектуре для общения сервисов между собой.

Алгоритмы распределения нагрузки:
- Статические алгоритмы - без знания о состоянии сервисных нод
  - [Round Robin](../algorithms/round_robin.md) - распределение запросов между инстансами по очереди. Один из самых простых и популярных алгоритмов
  - Random - инстанс получатель выбирается случайно
  - Hash - распределение запросов между инстансами по хэш-таблице. Хэш высчитывается из запроса, балансировщики могут позволять настроить ключ, который будет хэшироваться.
  - другие
- Динамические алгоритмы - используют знание о состоянии сервисных нод
  - Load based - балансировщик мониторит нагрузку на ЦПУ разных сервисов и перенаправляет запрос наименее нагруженному
  - Least connections - новый запрос отправляется на инстанс, с которым открыто наименьшее количество соединений
  - Least time - новый запрос отправляется на инстанс, который быстрее всех отвечает
  - другие

Для наиболее эффективного распределения нагрузки между инстансами балансировщик должен обладать дополнительной информацией о задачах (запросах) и о нодах, выполняющих эти задачи.
Иногда несколько последовательных запросов могут быть связаны друг с другом и должны быть отправлены на один и тот же инстанс сервиса.
Такое бывает, когда сервис является stateful.
В этом случае используется механизм липких сессий - sticky sessions.

Во многих кластерных решениях, например в некоторых базах данных - [Cassandra](../database/cassandra.md), [Hazelcast](../external_lib/hazelcast.md) и др. механизм балансировщика нагрузки встроен в сам сервис (в каждую ноду).
При этом выбирается master нода, на которую сыпятся запросы, а она уже сама распределяет их по другим нодам.


## Health checks
Балансировщики должны мониторить состояние нод, чтобы не перенаправлять запросы на упавшие инстансы.
Обычно это делается с помощью [health check](./healthcheck.md)'ов.

С некоторым интервалом времени балансировщик опрашивает все ноды, отправляя им ping или запрос состояния.
Размер интервала зависит от назначения и особенностей системы.
Для типовых web-приложений чаще всего он составляет единицы секунд.


## Решения
Nginx имеет функционал балансировки запросов.
Большинство облачных провайдеров предоставляют готовые балансировщики для ваших сервисов.

В Java мире в части client-side балансировщика одно время был популярен Netflix Ribbon, но они закрыли проект ориентировочно в 2020 г.
Теперь в Spring-сообществе используется Spring Cloud LoadBalancer.

---
## К изучению
- [X] [Видео про концепцию Load Balancing. 9:27](https://www.youtube.com/watch?v=gMIslJN44P0&ab_channel=BeABetterDev)

