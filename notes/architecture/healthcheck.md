---
title: "Healthcheck"
tags: 
  - architecture
  - pattern
draft: false
---

# Healthcheck

__Healthcheck__ - это архитектурный паттерн, при котором в приложение добавляется эндпойнт, отвечающий на простой вопрос: функционирует ли сервис прямо сейчас.

Как правило, эндпойнт возвращает одно из двух состояний: _UP_ или _DOWN_.
Также в ответ эндпойнта могут включаться данные о состоянии его внутренних модулей и о состоянии зависимостей сервиса: баз данных, очередей, других сервисов.

Например, у сервиса есть база данных и он зависит от другого внешнего сервиса.
А также у сервиса есть кэш словарных данных, без которых он не может работать, и ряд плагинов, каждый из которых может засбоить.

![healthcheck schema](../../images/src/healthcheck.drawio.svg)

Если сервис предоставляет JSON HTTP API, то запрос-ответ на healthcheck эндпойнт мог бы выглядеть так:
```
GET /health

{
    "status": "DOWN",
    "info": [
        {
            "db": "DOWN",
            "message": "Can't write to dir /var/cooldb/ : not enough permissions"
        },
        { "extService": "UP" },
        { "dictCache": "UP" },
        { "plugins": "UP" }
    ]
}
```

Запросы к сервису на healthcheck эндпойнта зачастую называются __пробами__ (probe) или __зондами__.

Healthcheck применяется в распределенных системах.
Например, на healthcheck могут быть завязаны [балансировщики](./load_balancer.md) и service discovery.
Если сервис переходит в состояние _DOWN_, то он на время исключается из балансировки.

Почти все коробочные распределенные системы с одноранговыми нодами используют healthcheck: Kafka, Hazelcast, Cassandra и т.д.
С помощью healthcheck ноды могут получать информацию о выходе других нод из кластера и об необходимости перебалансировке.
Например, если нода Hazelcast не отвечает на healtcheck или отвечает отрицательно, то те данные, за которые она отвечала, должны быть перераспределены между остальными нодами.


---
## Отслеживание healthcheck

При оценке работоспособности сервиса нельзя записывать его в отказавшие при единичных сбоях.
Сбой может быть вызван сетевыми неполадками, сборкой мусора или восстанавливаемыми сбоями внутри сервиса.
Поэтому как правило решения принимаются на основе массива показаний во временном окне.
Например, если сервис не отвечал на протяжении 5 секунд.

Частота запросов healthcheck и условия признания сервиса недоступным должны быть конфигурируемы.
Значения этих параметров надо выбирать исходя из условий функционирования сервиса.
Для нод одноранговых систем эти условия должны быть достаточно жесткими, чтобы оперативно реагировать на изменения в конфигурации системы.


---
## Реализация

В экосистеме JVM существует стандартная реализация паттерна healthcheck, предоставляемая модулем [Spring Boot Actuator](../spring/actuator.md).


---
## К изучению
- [X] [Health Check API](https://microservices.io/patterns/observability/health-check-api.html)
- [X] Видео [Как работает Healthcheck API](https://www.youtube.com/watch?v=7q-3xUk4fWM). 8:22
