---
title: "Двухфазный коммит"
tags:
  - distributed_system
draft: false
---

# Двухфазный коммит

Двухфазный коммит - это прием, который нужен, чтобы добиться атомарного коммита в распределенных системах.
В иностранной литературе название двухфазного коммита часто сокращают до 2PC.

Для двухфазного коммита нужен координатор.
При обычных транзакциях никакого координатора не нужно.
Клиент просто взаимодействует с мастер-нодой распределенного хранилища.

Рассмотрим ситуацию.
Клиент хочет закоммитить изменения в рамках транзакции.
Он отправляет данные коммита координатору.
Координатор рассылает нодам подготовительное сообщение и ждет от всех нод ответ о готовности принять изменения.
Если нода согласилась, то потом она уже не может отказаться от изменений.
Получив ответы от нод, координатор принимает решение коммитить ли транзакцию.
Коммит будет произведен только если все ноды ответили 'Ok'.
Если все согласны, то координатор рассылает всем нодам сообщение о необходимости закоммитить транзакцию.

Проблема двухфазного коммита заключается в том, что при падении координатора те транзакции, которые были открыты на нодах, но еще не были закоммичены, будут висеть до тех пор, пока координатор не поднимется.

Для того чтобы побороть эту проблему было придумано следующее.
Ноды, получив подготовительное сообщение, отправляют свое решение не только координатору, но и всем остальным нодам, которые участвуют в транзакции.

## К изучению
- [ ] [7 лекция](https://www.youtube.com/watch?v=-_rdWB9hN1c&list=PLeKd45zvjcDFUEv_ohr_HdUFe97RItdiB&index=21&ab_channel=MartinKleppmann) курса по распределенным системам от Мартина Клеппманна