---
title: "Юнит-тестирование (модульное тестирование)"
tags:
  - test
draft: false
---

Юнит-тестирование - тестирование отдельных частей ПО по отдельности. Тесты обычно пишутся для каждой нетривиальной функции или метода.

Цель юнит-тестирования - изолировать отдельные части программы и показать, что по отдельности они работоспособны.


---
## Школы тестирования

Существует две школы с разным подходом к юнит-тестам: классическая и лондонская.
Классическую школу также называют чикагской или детройтской по местонахождению Мартина Фаулера.
Лондонская же называется так по расположению S. Freeman и N. Pryce, написавших книгу Growing Object-Oriented Software, Guided by Tests.

**Лондонская школа** считает, что юнит - это класс, и что все зависимости класса должны быть замокированы в тесте.
Благодаря всеобщему мокированию тесты могут с поразительной точностью обнаруживать места, в которые закралась ошибка.
Написание тестов в духе лондонской школы ведет к хрупкости тестов - они начинают падать при любом рефакторинге, включающем изменение зависимостей класса.
Именно в стиле лондонской школы были написаны тесты в проекте EOM.

**Классическая школа** считает, что юнит - это единица поведения. 
Соответственно мокируются только разделяемые зависимости.
При разработке по методике TDD получаются как правило тесты классической школы.


---
## Структура теста

### AAA
Структура теста обычно подчиняется правилу **AAA - arrange, act, assert**:

- Подготовка входных данных, подготовка эталонных данных
- Вызов тестирующего метода
- Проверка результата работы метода с эталонными данными

```java
@Test
public void complementOf() {
  //arrange
  final EnumSet<ProfileType> onlyStaff = EnumSet.of(ProfileType.ADMIN, ProfileType.MODERATOR);

  //act
  final EnumSet<ProfileType> onlyClients = EnumSet.complementOf(onlyStaff);

  //assert
  assertEquals(onlyClients.size(), 2);
  assertTrue(onlyClients.contains(ProfileType.GUEST));
  assertTrue(onlyClients.contains(ProfileType.USER));
}
```

### Given-When-Then
Есть еще один вариант структуры тестов: **Given-When-Then** - когда при указанном состоянии системы и определенных входных данных (Given) произойдет какое-либо событие (When) ожидается переход системы в другое состояние и/или происхождение новых событий (Then).

Структура почти полностью повторяет AAA, но легче воспринимается людьми далекими от программирования.


---
## Тестовые двойники

При юнит-тестировании необходимо изолировать тестируемый код от внешних зависимостей, таких как база данных, внешние сервисы, файловая система и пр.
Для этих целей применяются различные виды тестовых двойников.
Понятие тестовых двойников и их разновидности вводятся в книге "xUnit Test Patterns: Refactoring Test Code":
- __Dummy__ - тестовая реализация интерфейса, которая ничего не делает. Каждый метод реализован так, чтобы не выполнять никаких действий и возвращать ответ близкий к `null`.
- __Stub__ - тестовая реализация интерфейса, способная отдавать данные при вызове методов, но не отслеживающая какие методы
- __Spy__ - тестовая реализация интерфейса, отслеживающая то, какие действия были с ней произведены: какие методы сколько раз вызваны с какими аргументами.
- __Mock__ - тестовая реализация интерфейса, отслеживающая то, какие действия были с ней произведены и сверяющая эти действия с ожидаемыми.
- __Fake__ - тестовая реализация интерфейса, эмулирующая реальные ответы на основе каких-либо признаков в аргументах.

Моки применяются для того, чтобы подменить зависимости, вызов которых ведет к сайд-эффектам.
Стабы применяются в тех случаях, когда вызываемый метод является чистой функцией, либо только отдает данные.

В Java-сообществе под __Spy__ обычно подразумеваются полноценные реализации зависимости (в отличие от моков), которые при этом отслеживают вызовы методов.
Ведь именно такой смысл они имеют в популярной библиотеке [Mockito](./mockito.md).


---
## Библиотеки для юнит-тестирования

Тесты могут представлять собой обычные классы с методами `main`. 
Запускать такие тесты придется самостоятельно.
Но как правило для юнит-тестов существуют специальные библиотеки, управляющие их жизненным циклом.
Один из самых популярных фреймворков - xUnit, где вместо 'x' подставляется идентификатор языка.

Java:
- [JUnit](junit.md) - наиболее популярная библиотека с большим количеством плагинов
- TestNG
- Spock (написан на Groovy, но может использоваться для тестирования Java кода)

C#:
- xUnit


---
## К изучению

- [X] Книга "Принципы юнит-тестирования" В. Хориков - 2021 г.
- [ ] Gerard Meszaros - xUnit Test Patterns: Refactoring Test Code - 2007 г.
- [ ] Роберт Мартин. Идеальная работа - 2022 г.  Глава 3
- [X] Хабр. [Анатомия юнит-тестов](https://habr.com/ru/post/554808/) (конспект части книги Хорикова) - 2021 г.
- [X] [Семинар от Немчинского](https://www.youtube.com/watch?v=KAny2OSYY3Y) (50 мин.)
