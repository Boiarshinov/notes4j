---
title: "Фильтр Блума"
tags:
  - data_structure
  - probabilistic
draft: false
---

# Фильтр Блума

**Фильтр Блума** - это вероятностная структура данных, которая позволяет определить входит ли значение в массив.
Вероятностной она называется из-за того, что при выдаче ответа она может с некоторой вероятностью наврать.
При этом если фильтр утверждает, что значения в массиве нет - значит его там действительно нет, а если утверждает, что есть, то он может с некоторой вероятностью ошибаться.
Ошибочное утверждение называется **ложноположительным срабатыванием**.

Зачем же нужна такая структура данных, которая может соврать?
Дело в том, что фильтр Блума отрабатывает очень быстро и занимает совсем немного места в памяти.

Важно понимать, что фильтр Блума не хранит значения элементов.
Также он не позволяет удалять элементы.
Если необходимо удалить элемент, то придется перестроить весь фильтр.


## Устройство

Фильтр Блума представляет собой битовый массив заданного размера.
При добавлении нового элемента в фильтр, из этого элемента высчитывается несколько хэш-функций.
Затем от вычисленных значений извлекается остаток от деления на размер массива. 
Получившиеся значения - это позиции в битовом массиве.
В этих позициях биты выставляются в `1`.

При определении наличия элемента в фильтре Блума, к нему опять применяются хэш-функции и определяется позиции в массиве.
Если во всех вычисленных позициях выставлены `1`, то элемент __возможно__ был добавлен в массив ранее. 
Если хотя бы одна позиция выставлена в `0`, то элемента в фильтре точно нет.

Ложноположительные срабатывания возникают тогда, когда значения хэш-функций выдают коллизию с значениями хэш-функций по другим элементам.
Например, если в фильтре Блума используется две хэш-функции и в него добавлено два элемента: `y` с значениями 8 и 3, и `z` со значениями 5 и 2, то при определении наличия элемента `x` со значениями хэш-функций 8 и 2, произойдет ложноположительное срабатывание, хотя элемент никогда не добавлялся в фильтр.

Существуют формулы, которые позволяют по ориентировочному количеству хранимых элементов и желаемой вероятности ложноположительных срабатываний вычислить размер массива.

### Применение
Фильтр Блума используется для того чтобы сократить время поиска элементов в других структурах данных, доступ к которым не так быстр.
Благодаря фильтру Блума можно сделать однозначное заключение о том, что элемент отсутствует и сэкономить время на поиск по низлежащей структурой.

Фильтр Блума используется в [Apache Cassandra](../database/cassandra.md) для того чтобы ускорить сканирование элементов по sstable.


## Реализация

Ниже приведена реализация на языке Java.
Из-за того, что в Java не существует способа задания битового массива с помощью примитивных типов данных, в реализации используется класс из стандартной библиотеки - `BitSet`.
```java
public class BloomFilter<T> {

    private BitSet bitArray;
    private ToIntFunction<T>[] hashFunctions;

    public BloomFilter(int arraySize, ToIntFunction<T>[] hashFunctions) {
        this.hashFunctions = hashFunctions;
        this.bitArray = new BitSet(arraySize);
    }

    public void insert(T key) {
        for (ToIntFunction<T> hashFunction : hashFunctions){
            int position = hashFunction.applyAsInt(key) % bitArray.size();
            bitArray.set(position);
        }
    }

    public boolean contains(T key) {
        for (ToIntFunction<T> hashFunction : hashFunctions){
            int position = hashFunction.applyAsInt(key) % bitArray.size();
            if (!bitArray.get(position)) {
                return false;
            }
        }
        return true;
    }
}
```

---
## К изучению

- [ ] [Wiki](https://en.wikipedia.org/wiki/Bloom_filter)
- [X] Книга Алекса Петрова "Распределенные данные", глава 7