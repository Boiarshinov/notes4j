---
title: "Nginx"
tags:
  - devops
  - web
draft: false
---

# Nginx

Nginx - это веб-сервер.
Аналогом Nginx является Apache Web Server.

Nginx может использоваться в качестве веб-сервера для отдачи файлов, находящихся на сервере. Также Nginx может использоваться в качестве прокси, принимая запросы от клиентов, переадресуя их серверным приложениям, и возвращая ответ от приложений клиентам.

## Конфигурация

Конфигурация nginx производится с помощью файлика `nginx.conf`, который находится в `/etc/nginx/`.

**Контекст** - раздел конфигурации, в котором задаются директивы
```conf
http {
    ...
}
```

**Директива** - конкретная настройка в формате ключ - значение. Директива заканчивается точкой с запятой.
```conf
worker_connections 1024;
```

Директивы, объявленные вне какого-либо контекста, относятся к главному (main) контексту.

Контексты:
- `events` - ... . Контекст `events` является обязательным для `nginx.conf`, даже если в нем ничего не задается
- `http` - контекст протокола HTTP
  - `types` - MIME типы, с которым будет отдаваться различный контент
  - `server` - контекст реального сервера, характеризуемого IP-адресом
    - `location` - здесь указываются параметры веб сервера для определенного шаблона URI. При обработке запросов используется location с наиболее подходящим URI.

Пример конфигурации
```conf
events {}

http {
    include mime.types; # Подключение файла устанавливающего соответствие расширений файлов отдаваемым mime типам

    types { # Не нужно прописывать в большинстве случаев, если подключен файл mime.types
        text/html html; # Все файлы с расширением .html будут отдаваться с MIME типом text/html
        text/css css;
    }

    server {
        listen 80; # Прослушиваемый порт. 80- порт по умолчанию
        server_name 127.0.0.1; #IP адрес сервера или его доменное имя
        root ???; # ???

        location /api { # Настройки для всех запросов с URL, начинающегося с /api.

        }
    }
}
```

Если конфигурация получается слишком большой, то рекомендуется разбивать ее на отдельные файлы, которые размещаются в директории `/etc/nginx/conf.d/`.
Файлики подтягиваются в `nginx.conf` с помощью ключевого слова `include`.
```conf
include conf.d/stream_app.conf;
```

Часто можно встретить импорт по wildcard:
```conf
include conf.d/*.conf;
```

### Конфигурация в качестве прокси

При конфигурации в качестве прокси в контексте `location` необходимо задать адрес сервиса, которому будут переадресовываться запросы.
```conf
server {
    listen 443;
    server_name boiarshinov.dev;

    location / {
        # Переадресуем абсолютно все запросы на локально развернутое приложение, слушающее порт 8080
        proxy_pass http://localhost:8080/;
    }
}
```

### Распределение нагрузки

Nginx позволяет распределять нагрузку по различным инстансам одного приложения.
Сервера инстансов указываются в контексте `upstream`:
```conf
upstream mainApp {
    server dc1.mainApp.instance1:8080;
    server dc1.mainApp.instance2:8080;
    server dc1.mainApp.instance3:8080;
}
```

Затем перечень инстансов указывается в контексте `location`:
```conf
server {

    location /mainapp {
        # После указания протокола следует название upstream
        proxy_pass http://mainApp
    }
}
```

По умолчанию запросы распределяются по серверам циклически по алгоритму [round robin](../algorithms/round_robin.md).
Можно задать вес сервера с помощью параметра `weight`.
```conf
upstream mainApp {
    # Из 5 запросов 3 будут отправлены на 1 сервер
    server dc1.mainApp.instance1:8080 weight = 3;
    server dc1.mainApp.instance2:8080;
    server dc1.mainApp.instance3:8080;
}
```

### Логирование
Логирование в nginx ведется в два потока:
- лог ошибок
- лог всех запросов

В стандартной конфигурации nginx логи пишутся в файлы `error.log` и `access.log`, находящиеся в директории `/var/log/nginx/`.
Местоположение лог-файлов можно изменить в файле конфигурации с помощью настроек `error_log` и `access_log`:
```conf
error_log /var/log/nginx/app1/error.log warn;
access_log /var/log/nginx/app1/access.log my_log_format;
```
Прописать настройки можно в любом контексте, они будут наследоваться из более глобальных контекстов в более специфические.
Если этих настроек не будет в конфиге, то nginx не будет логировать вовсе.

Для `error_log` после указания лог-файла нужно задать уровень логирования.
Существуют следующие уровни:
- `debug`
- `info`
- `warn`
- `error`
- `crit`
- `alert`
- `emerg`

Для `access_log` после указания лог-файла нужно указать формат логирования.
Для этого необходимо предварительно объявить формат с помощью настройки `log_format`:
```conf
log_format main '$remote_addr - $remote_user [$time_local] "$request" '
'$status $body_bytes_sent "$http_referer" '
'"$http_user_agent" "$http_x_forwarded_for"';

access_log /var/log/nginx/access.log main;
```

Если сервис очень нагруженный, то чтобы логирование в nginx не стало бутылочным горлышком, его можно отключить:
```conf
access_log off;
```

Сам nginx не умеет архивировать старые логи. 
Для этого приходится писать малую автоматизацию на cron джобах, либо пользоваться специальным ПО, например **logrotate**.


---
## CLI

Запуск Nginx
```sh
service nginx start
```

Проверка валидности конфигурационного файла:
```sh
nginx -t
```

Перезагрузка Nginx. Используется при изменении конфигурации
```sh
service nginx reload
```


---
## К изучению
- [ ] [Официальная документация](https://nginx.org/ru/docs/)
- [ ] [Цикл переведенных видео по Nginx](https://www.youtube.com/playlist?list=PLhgRAQ8BwWFa7ulOkX0qi5UfVizGD_-Rc)
- [X] Статья про [Логирование в Nginx](https://linuxhint.com/enable-debug-logs-nginx/)